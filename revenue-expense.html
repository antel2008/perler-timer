<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶æ”¯ç®¡ç† - æ‹¼è±†è®¡æ—¶å™¨ Pro V1.0</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ‹¼è±†è®¡æ—¶å™¨">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        @media (max-width: 768px) {
            .revenue-expense-page {
                padding: 15px 12px 90px 12px !important;
            }
            
            .page-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                margin-bottom: 20px;
            }
            
            .header-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .header-actions .btn {
                width: 100%;
            }
            
            .stats-overview {
                flex-direction: column;
                gap: 20px;
                margin-bottom: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 12px 8px;
            }
            
            .stat-icon {
                font-size: 1.5rem;
            }
            
            .stat-value {
                font-size: 1.1rem;
            }
            
            .stat-label {
                font-size: 0.85rem;
            }
            
            .stats-summary {
                flex-direction: column;
                gap: 8px;
            }
            
            .tab-header {
                flex-direction: row;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                padding: 10px 12px;
                font-size: 0.9rem;
                white-space: nowrap;
            }
            
            .filter-section {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
            }
            
            .filter-group label {
                font-size: 0.9rem;
            }
            
            .filter-group select,
            .filter-group input {
                width: 100%;
                font-size: 16px;
                padding: 10px;
            }
            
            .order-item,
            .expense-item {
                margin-bottom: 12px;
                padding: 12px;
            }
            
            .order-header,
            .expense-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .order-info {
                flex-wrap: wrap;
                gap: 6px;
                margin: 8px 0;
            }
            
            .order-amount {
                flex-direction: column;
                align-items: flex-end;
                gap: 4px;
            }
            
            .order-final {
                font-size: 1.2rem;
                font-weight: 600;
            }
            
            .order-extras {
                flex-direction: row;
                justify-content: space-between;
                font-size: 0.85rem;
            }
            
            .modal-content {
                max-width: 95% !important;
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 16px;
                padding: 12px;
            }
            
            .form-group label {
                font-size: 0.9rem;
            }
            
            .expense-bead-list {
                max-height: 200px;
                overflow-y: auto;
            }
            
            .expense-bead-item {
                flex-direction: row;
                padding: 8px;
            }
            
            .expense-bead-preview {
                width: 40px;
                height: 40px;
                font-size: 0.7rem;
            }
            
            .expense-bead-info {
                flex: 1;
                padding: 0 10px;
            }
            
            .expense-bead-name {
                font-size: 0.9rem;
            }
            
            .expense-bead-amount {
                font-size: 0.85rem;
            }
            
            .modal-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
            
            .empty-hint {
                padding: 30px 20px;
                font-size: 0.9rem;
            }
            
            .order-detail-section {
                padding: 12px 0;
            }
            
            .order-detail-section h3 {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            
            .detail-row {
                padding: 6px 0;
                font-size: 0.9rem;
            }
            
            .order-other-charges-list,
            .order-bead-usage-list {
                max-height: 200px;
                overflow-y: auto;
            }
            
            .order-other-charge-item,
            .order-bead-usage-item {
                font-size: 0.85rem;
                padding: 6px 0;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <nav class="sidebar">
            <a href="index.html" class="logo">
                <h2 id="shopNameDisplay">ğŸ¨ æ‹¼è±†è®¡æ—¶å™¨</h2>
                <span class="version">V1.0</span>
            </a>
            
            <div class="nav-menu">
                <a href="timer.html" class="nav-item">
                    <span class="icon">â±ï¸</span>
                    <span>æ”¶è´¹ç®¡ç†</span>
                </a>
                <a href="inventory.html" class="nav-item">
                    <span class="icon">ğŸ“¦</span>
                    <span>åº“å­˜ç®¡ç†</span>
                </a>
                <a href="revenue-expense.html" class="nav-item active">
                    <span class="icon">ğŸ’°</span>
                    <span>æ”¶æ”¯ç®¡ç†</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <span class="icon">âš™ï¸</span>
                    <span>ç³»ç»Ÿè®¾ç½®</span>
                </a>
            </div>
        </nav>
        
        <main class="main-content">
            <div class="revenue-expense-page">
                <div class="page-header">
                    <h1>ğŸ’° æ”¶æ”¯ç®¡ç†</h1>
                    <div class="header-actions">
                        <button onclick="openAddExpenseModal()" class="btn btn-success">â• æ·»åŠ æ”¯å‡º</button>
                        <button onclick="exportData()" class="btn btn-secondary">ğŸ“¤ å¯¼å‡ºæŠ¥è¡¨</button>
                    </div>
                </div>
                
                <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                <div class="stats-overview">
                    <div class="stats-section">
                        <h3>ğŸ“Š ä»Šæ—¥ç»Ÿè®¡</h3>
                        <div class="stats-grid">
                            <div class="stat-card income">
                                <div class="stat-icon">ğŸ’µ</div>
                                <div class="stat-info">
                                    <div class="stat-label">æ”¶å…¥</div>
                                    <div class="stat-value" id="todayIncome">Â¥0.00</div>
                                </div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-icon">ğŸ’¸</div>
                                <div class="stat-info">
                                    <div class="stat-label">æ”¯å‡º</div>
                                    <div class="stat-value" id="todayExpense">Â¥0.00</div>
                                </div>
                            </div>
                            <div class="stat-card profit">
                                <div class="stat-icon">ğŸ“ˆ</div>
                                <div class="stat-info">
                                    <div class="stat-label">å‡€åˆ©æ¶¦</div>
                                    <div class="stat-value" id="todayNetProfit">Â¥0.00</div>
                                </div>
                            </div>
                        </div>
                        <div class="stats-summary">
                            <div class="summary-item">
                                <span class="summary-label">è®¢å•æ•°ï¼š</span>
                                <span class="summary-value" id="todayOrderCount">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">å®¢å•ä»·ï¼š</span>
                                <span class="summary-value" id="todayAvgOrder">Â¥0.00</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">åˆ©æ¶¦ç‡ï¼š</span>
                                <span class="summary-value" id="todayProfitRate">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-section">
                        <h3>ğŸ“… æœ¬æœˆç»Ÿè®¡</h3>
                        <div class="stats-grid">
                            <div class="stat-card income">
                                <div class="stat-icon">ğŸ’µ</div>
                                <div class="stat-info">
                                    <div class="stat-label">æ”¶å…¥</div>
                                    <div class="stat-value" id="monthIncome">Â¥0.00</div>
                                </div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-icon">ğŸ’¸</div>
                                <div class="stat-info">
                                    <div class="stat-label">æ”¯å‡º</div>
                                    <div class="stat-value" id="monthExpense">Â¥0.00</div>
                                </div>
                            </div>
                            <div class="stat-card profit">
                                <div class="stat-icon">ğŸ“ˆ</div>
                                <div class="stat-info">
                                    <div class="stat-label">å‡€åˆ©æ¶¦</div>
                                    <div class="stat-value" id="monthNetProfit">Â¥0.00</div>
                                </div>
                            </div>
                        </div>
                        <div class="stats-summary">
                            <div class="summary-item">
                                <span class="summary-label">è®¢å•æ•°ï¼š</span>
                                <span class="summary-value" id="monthOrderCount">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">å®¢å•ä»·ï¼š</span>
                                <span class="summary-value" id="monthAvgOrder">Â¥0.00</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">åˆ©æ¶¦ç‡ï¼š</span>
                                <span class="summary-value" id="monthProfitRate">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            
            <!-- æ ‡ç­¾é¡µ -->
            <div class="tab-container">
                <div class="tab-header">
                    <button class="tab-btn active" onclick="switchTab('orders')">ğŸ“‹ æ”¶å…¥è®°å½•</button>
                    <button class="tab-btn" onclick="switchTab('expenses')">ğŸ’¸ æ”¯å‡ºè®°å½•</button>
                </div>
                
                <div class="tab-content">
                    <!-- æ”¶å…¥è®°å½•æ ‡ç­¾é¡µ -->
                    <div id="ordersTab" class="tab-pane active">
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>æ—¥æœŸï¼š</label>
                                <input type="date" id="orderDateFilter" class="form-control" onchange="loadOrders()">
                            </div>
                            <div class="filter-group">
                                <label>æ¡Œä½ï¼š</label>
                                <select id="orderTableFilter" class="form-control" onchange="loadOrders()">
                                    <option value="all">å…¨éƒ¨</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>å®¢æˆ·ç±»å‹ï¼š</label>
                                <select id="orderCustomerFilter" class="form-control" onchange="loadOrders()">
                                    <option value="all">å…¨éƒ¨</option>
                                    <option value="normal">æ™®é€šå®¢æˆ·</option>
                                    <option value="member">ä¼šå‘˜</option>
                                    <option value="vip">VIP</option>
                                    <option value="student">å­¦ç”Ÿ</option>
                                    <option value="meituan">ç¾å›¢å›¢è´­</option>
                                    <option value="douyin">æŠ–éŸ³å›¢è´­</option>
                                    <option value="dianping">å¤§ä¼—ç‚¹è¯„</option>
                                    <option value="xiaohongshu">å°çº¢ä¹¦</option>
                                </select>
                            </div>
                        </div>
                        <div id="orderList" class="order-list"></div>
                    </div>
                    
                    <!-- æ”¯å‡ºè®°å½•æ ‡ç­¾é¡µ -->
                    <div id="expensesTab" class="tab-pane">
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>ç±»å‹ï¼š</label>
                                <select id="expenseTypeFilter" class="form-control" onchange="loadExpenses()">
                                    <option value="all">å…¨éƒ¨</option>
                                    <option value="rent">æˆ¿ç§Ÿ</option>
                                    <option value="purchase">è¿›è´§</option>
                                    <option value="utilities">æ°´ç”µ</option>
                                    <option value="salary">äººå·¥</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>æœˆä»½ï¼š</label>
                                <input type="month" id="expenseMonthæœˆFilter" class="form-control" onchange="loadExpenses()">
                            </div>
                        </div>
                        <div id="expenseList" class="expense-list"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- æ·»åŠ æ”¯å‡ºå¼¹çª— -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>- æ·»åŠ æ”¯å‡º</h2>
            <div class="form-group">
                <label>æ”¯å‡ºç±»å‹</label>
                <select id="expenseType" class="form-control" onchange="toggleExpenseBeadSection()">
                    <option value="rent">æˆ¿ç§Ÿ</option>
                    <option value="purchase">è¿›è´§</option>
                    <option value="utilities">æ°´ç”µ</option>
                    <option value="salary">äººå·¥</option>
                    <option value="other">å…¶ä»–</option>
                </select>
            </div>
            <div class="form-group">
                <label>é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="expenseAmount" class="form-control" step="0.01" min="0" placeholder="è¯·è¾“å…¥é‡‘é¢">
            </div>
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="expenseDate" class="form-control">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea id="expenseNote" class="form-control" placeholder="å¤‡æ³¨ä¿¡æ¯..."></textarea>
            </div>
            
            <div id="expenseBeadSection" style="display: none;">
                <hr>
                <div class="form-group">
                    <label>ğŸ¨ å…³è”æ‹¼è±†åº“å­˜</label>
                    <div id="expenseBeadList" class="expense-bead-list"></div>
                    <button onclick="addExpenseBeadItem()" class="btn btn-sm btn-success" style="margin-top: 10px;">â• æ·»åŠ æ‹¼è±†</button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button onclick="closeAddExpenseModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmAddExpense()" class="btn btn-success">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- è´¹ç”¨æ‹¼è±†é¡¹å¼¹çª— -->
    <div id="expenseBeadItemModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>ğŸ¨ æ·»åŠ æ‹¼è±†</h2>
            <div class="form-group">
                <label>é€‰æ‹©è‰²å·</label>
                <select id="expenseBeadColorSelect" class="form-control">
                    <option value="">è¯·é€‰æ‹©è‰²å·...</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ•°é‡ï¼ˆå…‹ï¼‰</label>
                <input type="number" id="expenseBeadAmount" class="form-control" step="1" min="1" placeholder="ä¾‹å¦‚ï¼š100">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <input type="text" id="expenseBeadNote" class="form-control" placeholder="å¤‡æ³¨ä¿¡æ¯...">
            </div>
            <div class="modal-actions">
                <button onclick="closeExpenseBeadItemModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmAddExpenseBeadItem()" class="btn btn-success">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- è®¢å•è¯¦æƒ…å¼¹çª— -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2>ğŸ“‹ è®¢å•è¯¦æƒ…</h2>
            <div id="orderDetailContent"></div>
            <div class="modal-actions">
                <button onclick="closeOrderDetailModal()" class="btn btn-primary">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <script src="bead-data.js"></script>
    <script src="common.js"></script>
    <script src="csv-export.js"></script>
    <script>
        let currentExpenseBeads = [];
        
        function initRevenueExpensePage() {
            loadConfig();
            updateShopNameDisplay();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            loadOrders();
            loadExpenses();
            updateStats();
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const orders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
            const expenses = JSON.parse(localStorage.getItem('perlerTimerExpenses') || '[]');
            
            const todayOrders = orders.filter(o => o.date === today);
            const monthOrders = orders.filter(o => o.date.startsWith(currentMonth));
            
            const todayExpenses = expenses.filter(e => e.date === today);
            const monthExpenses = expenses.filter(e => e.date.startsWith(currentMonth));
            
            const todayIncome = todayOrders.reduce((sum, o) => sum + (o.actualPayment || 0), 0);
            const monthIncome = monthOrders.reduce((sum, o) => sum + (o.actualPayment || 0), 0);
            
            const todayExpense = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
            const monthExpense = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            const todayNetProfit = todayIncome - todayExpense;
            const monthNetProfit = monthIncome - monthExpense;
            
            const todayOrderCount = todayOrders.length;
            const monthOrderCount = monthOrders.length;
            
            const todayAvgOrder = todayOrderCount > 0 ? todayIncome / todayOrderCount : 0;
            const monthAvgOrder = monthOrderCount > 0 ? monthIncome / monthOrderCount : 0;
            
            const todayProfitRate = todayIncome > 0 ? (todayNetProfit / todayIncome * 100) : 0;
            const monthProfitRate = monthIncome > 0 ? (monthNetProfit / monthIncome * 100) : 0;
            
            document.getElementById('todayIncome').textContent = `Â¥${todayIncome.toFixed(2)}`;
            document.getElementById('todayExpense').textContent = `Â¥${todayExpense.toFixed(2)}`;
            document.getElementById('todayNetProfit').textContent = `Â¥${todayNetProfit.toFixed(2)}`;
            document.getElementById('monthIncome').textContent = `Â¥${monthIncome.toFixed(2)}`;
            document.getElementById('monthExpense').textContent = `Â¥${monthExpense.toFixed(2)}`;
            document.getElementById('monthNetProfit').textContent = `Â¥${monthNetProfit.toFixed(2)}`;
            
            document.getElementById('todayOrderCount').textContent = todayOrderCount;
            document.getElementById('todayAvgOrder').textContent = `Â¥${todayAvgOrder.toFixed(2)}`;
            document.getElementById('todayProfitRate').textContent = `${todayProfitRate.toFixed(1)}%`;
            
            document.getElementById('monthOrderCount').textContent = monthOrderCount;
            document.getElementById('monthAvgOrder').textContent = `Â¥${monthAvgOrder.toFixed(2)}`;
            document.getElementById('monthProfitRate').textContent = `${monthProfitRate.toFixed(1)}%`;
            
            const todayProfitEl = document.getElementById('todayNetProfit');
            todayProfitEl.style.color = todayNetProfit >= 0 ? '#27ae60' : '#e74c3c';
            
            const monthProfitEl = document.getElementById('monthNetProfit');
            monthProfitEl.style.color = monthNetProfit >= 0 ? '#27ae60' : '#e74c3c';
        }
        
        function loadOrders() {
            const orders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
            const dateFilter = document.getElementById('orderDateFilter').value;
            const tableFilter = document.getElementById('orderTableFilter').value;
            const customerFilter = document.getElementById('orderCustomerFilter').value;
            
            let filteredOrders = orders;
            
            if (dateFilter) {
                filteredOrders = filteredOrders.filter(order => order.date === dateFilter);
            }
            
            if (tableFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.tableId === tableFilter);
            }
            
            if (customerFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.customerType === customerFilter);
            }
            
            const container = document.getElementById('orderList');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = '<div class="empty-hint">æš‚æ— æ”¶å…¥è®°å½•</div>';
                return;
            }
            
            container.innerHTML = filteredOrders.map(order => {
                const duration = order.duration;
                const hours = Math.floor(duration / (1000 * 60 * 60));
                const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                const durationText = hours > 0 ? `${hours}å°æ—¶${minutes}åˆ†é’Ÿ` : `${minutes}åˆ†é’Ÿ`;
                
                return `
                <div class="order-item" onclick="showOrderDetail('${order.id}')">
                    <div class="order-header">
                        <div class="order-table">${order.tableName}</div>
                        <div class="order-date">${order.date}</div>
                    </div>
                    <div class="order-info">
                        <div class="order-type ${order.customerType}">${getCustomerTypeName(order.customerType)}</div>
                        <div class="order-charge-type">${order.chargeType === 'daily' ? 'åŒ…æ—¥' : order.chargeType === 'groupbuy' ? 'å›¢è´­' : 'æŒ‰æ—¶é•¿'}</div>
                        <div class="order-duration">${durationText}</div>
                    </div>
                    <div class="order-amount">
                        <div class="order-original">Â¥${order.originalPrice.toFixed(2)}</div>
                        ${order.discount > 0 ? `<div class="order-discount">-${(order.discount * 100).toFixed(0)}%</div>` : ''}
                        <div class="order-final">Â¥${order.actualPayment.toFixed(2)}</div>
                        ${order.platformFee > 0 ? `<div class="order-net">å®æ”¶: Â¥${order.netIncome.toFixed(2)}</div>` : ''}
                    </div>
                    ${order.otherCharges && order.otherCharges.length > 0 ? `
                    <div class="order-extras">
                        <span class="extras-label">å…¶ä»–æ”¶è´¹ï¼š</span>
                        <span class="extras-total">Â¥${order.otherChargesTotal.toFixed(2)}</span>
                    </div>
                    ` : ''}
                </div>
            `}).join('');
            
            updateTableFilter();
        }
        
        function updateTableFilter() {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const select = document.getElementById('orderTableFilter');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="all">å…¨éƒ¨</option>';
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = table.name;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }
        
        function showOrderDetail(orderId) {
            const orders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
            const order = orders.find(o => o.id === orderId);
            
            if (!order) return;
            
            const duration = order.duration;
            const hours = Math.floor(duration / (1000 * 60 * 60));
            const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
            
            let content = `
                <div class="order-detail-section">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <div class="detail-row">
                        <span>æ¡Œä½ï¼š</span>
                        <span>${order.tableName}</span>
                    </div>
                    <div class="detail-row">
                        <span>å¼€å§‹æ—¶é—´ï¼š</span>
                        <span>${new Date(order.startTime).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span>ç»“æŸæ—¶é—´ï¼š</span>
                        <span>${new Date(order.endTime).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span>ä½¿ç”¨æ—¶é•¿ï¼š</span>
                        <span>${hours}å°æ—¶${minutes}åˆ†é’Ÿ</span>
                    </div>
                    <div class="detail-row">
                        <span>è®¡è´¹æ–¹å¼ï¼š</span>
                        <span>${order.chargeType === 'daily' ? 'åŒ…æ—¥è®¡è´¹' : order.chargeType === 'groupbuy' ? 'å›¢è´­å¥—é¤' : 'æŒ‰æ—¶é•¿è®¡è´¹'}</span>
                    </div>
                    <div class="detail-row">
                        <span>å®¢æˆ·ç±»å‹ï¼š</span>
                        <span>${getCustomerTypeName(order.customerType)}</span>
                    </div>
                </div>
                
                <div class="order-detail-section">
                    <h3>è´¹ç”¨æ˜ç»†</h3>
                    <div class="detail-row">
                        <span>åŸä»·ï¼š</span>
                        <span>Â¥${order.originalPrice.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span>æŠ˜æ‰£ï¼š</span>
                        <span>${order.discount > 0 ? (order.discount * 100).toFixed(0) + '%' : 'æ— '}</span>
                    </div>
                    ${order.platformFee > 0 ? `
                    <div class="detail-row">
                        <span>å¹³å°è´¹ç”¨ï¼š</span>
                        <span>Â¥${order.platformFee.toFixed(2)} (${(order.platformFeeRate * 100).toFixed(0)}%)</span>
                    </div>
                    <div class="detail-row">
                        <span>å®é™…åˆ°è´¦ï¼š</span>
                        <span>Â¥${order.netIncome.toFixed(2)}</span>
                    </div>
                    ` : ''}
                    <div class="detail-row total">
                        <span>åº”æ”¶é‡‘é¢ï¼š</span>
                        <span>Â¥${order.actualPayment.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            if (order.otherCharges && order.otherCharges.length > 0) {
                content += `
                    <div class="order-detail-section">
                        <h3>å…¶ä»–æ”¶è´¹</h3>
                        <div class="order-other-charges-list">
                            ${order.otherCharges.map(charge => `
                                <div class="order-other-charge-item">
                                    <span>${charge.name}</span>
                                    <span>Â¥${charge.price.toFixed(2)} Ã— ${charge.quantity}${charge.unit}</span>
                                    <span>Â¥${charge.total.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="detail-row total">
                            <span>å…¶ä»–æ”¶è´¹æ€»è®¡ï¼š</span>
                            <span>Â¥${order.otherChargesTotal.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }
            
            if (order.beadUsage && order.beadUsage.length > 0) {
                content += `
                    <div class="order-detail-section">
                        <h3>æ‹¼è±†ä½¿ç”¨</h3>
                        <div class="order-bead-usage-list">
                            ${order.beadUsage.map(usage => `
                                <div class="order-bead-usage-item">
                                    <div class="bead-code" style="background-color: ${usage.color};">${usage.code}</div>
                                    <span class="bead-name">${usage.name}</span>
                                    <span class="bead-amount">${usage.amount}g</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="detail-row total">
                            <span>æ‹¼è±†æ€»è®¡ï¼š</span>
                            <span>${order.beadUsageTotal}g</span>
                        </div>
                    </div>
                `;
            }
            
            if (order.checkoutNote) {
                content += `
                    <div class="order-detail-section">
                        <h3>å¤‡æ³¨</h3>
                        <p>${order.checkoutNote}</p>
                    </div>
                `;
            }
            
            document.getElementById('orderDetailContent').innerHTML = content;
            document.getElementById('orderDetailModal').style.display = 'flex';
        }
        
        function closeOrderDetailModal() {
            document.getElementById('orderDetailModal').style.display = 'none';
        }
        
        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem('perlerTimerExpenses') || '[]');
            const typeFilter = document.getElementById('expenseTypeFilter').value;
            const monthFilter = document.getElementById('expenseMonthFilter').value;
            
            let filteredExpenses = expenses;
            
            if (typeFilter !== 'all') {
                filteredExpenses = filteredExpenses.filter(expense => expense.type === typeFilter);
            }
            
            if (monthFilter) {
                filteredExpenses = filteredExpenses.filter(expense => expense.date.startsWith(monthFilter));
            }
            
            const container = document.getElementById('expenseList');
            
            if (filteredExpenses.length === 0) {
                container.innerHTML = '<div class="empty-hint">æš‚æ— æ”¯å‡ºè®°å½•</div>';
                return;
            }
            
            container.innerHTML = filteredExpenses.map(expense => `
                <div class="expense-item">
                    <div class="expense-header">
                        <div class="expense-type ${expense.type}">${getExpenseTypeName(expense.type)}</div>
                        <div class="expense-date">${new Date(expense.date).toLocaleDateString()}</div>
                    </div>
                    <div class="expense-amount">
                        <div class="expense-value">Â¥${expense.amount.toFixed(2)}</div>
                    </div>
                    <div class="expense-note">${expense.note || '-'}</div>
                    <button onclick="deleteExpense('${expense.id}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                </div>
            `).join('');
        }
        
        function getExpenseTypeName(type) {
            const types = {
                rent: 'æˆ¿ç§Ÿ',
                purchase: 'è¿›è´§',
                utilities: 'æ°´ç”µ',
                salary: 'äººå·¥',
                other: 'å…¶ä»–'
            };
            return types[type] || type;
        }
        
        function openAddExpenseModal() {
            document.getElementById('expenseType').value = 'rent';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseNote').value = '';
            document.getElementById('expenseBeadSection').style.display = 'none';
            currentExpenseBeads = [];
            updateExpenseBeadList();
            document.getElementById('addExpenseModal').style.display = 'flex';
        }
        
        function closeAddExpenseModal() {
            document.getElementById('addExpenseModal').style.display = 'none';
        }
        
        function toggleExpenseBeadSection() {
            const type = document.getElementById('expenseType').value;
            const section = document.getElementById('expenseBeadSection');
            section.style.display = type === 'purchase' ? 'block' : 'none';
        }
        
        function loadExpenseBeadColorSelect() {
            const beads = JSON.parse(localStorage.getItem('perlerTimerBeads')) || [];
            const select = document.getElementById('expenseBeadColorSelect');
            
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è‰²å·...</option>';
            beads.forEach(bead => {
                const option = document.createElement('option');
                option.value = bead.code;
                option.textContent = `${bead.code} - ${bead.name} (åº“å­˜: ${bead.stockGram}g)`;
                option.style.color = bead.color;
                select.appendChild(option);
            });
        }
        
        function openExpenseBeadItemModal() {
            loadExpenseBeadColorSelect();
            document.getElementById('expenseBeadColorSelect').value = '';
            document.getElementById('expenseBeadAmount').value = '';
            document.getElementById('expenseBeadNote').value = '';
            document.getElementById('expenseBeadItemModal').style.display = 'flex';
        }
        
        function closeExpenseBeadItemModal() {
            document.getElementById('expenseBeadItemModal').style.display = 'none';
        }
        
        function confirmAddExpenseBeadItem() {
            const colorCode = document.getElementById('expenseBeadColorSelect').value;
            const amount = parseInt(document.getElementById('expenseBeadAmount').value) || 0;
            const note = document.getElementById('expenseBeadNote').value;
            
            if (!colorCode) {
                alert('è¯·é€‰æ‹©è‰²å·ï¼');
                return;
            }
            
            if (amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡ï¼');
                return;
            }
            
            const beads = JSON.parse(localStorage.getItem('perlerTimerBeads')) || [];
            const bead = beads.find(b => b.code === colorCode);
            
            if (!bead) {
                alert('è‰²å·ä¸å­˜åœ¨ï¼');
                return;
            }
            
            currentExpenseBeads.push({
                code: bead.code,
                name: bead.name,
                color: bead.color,
                amount: amount,
                note: note
            });
            
            updateExpenseBeadList();
            closeExpenseBeadItemModal();
        }
        
        function removeExpenseBeadItem(index) {
            currentExpenseBeads.splice(index, 1);
            updateExpenseBeadList();
        }
        
        function updateExpenseBeadList() {
            const container = document.getElementById('expenseBeadList');
            
            if (currentExpenseBeads.length === 0) {
                container.innerHTML = '<div class="empty-hint">æš‚æ— æ‹¼è±†è®°å½•</div>';
                return;
            }
            
            container.innerHTML = currentExpenseBeads.map((item, index) => `
                <div class="expense-bead-item">
                    <div class="expense-bead-preview" style="background-color: ${item.color};">
                        ${item.code}
                    </div>
                    <div class="expense-bead-info">
                        <div class="expense-bead-name">${item.name}</div>
                        <div class="expense-bead-amount">${item.amount}g</div>
                        ${item.note ? `<div class="expense-bead-note">${item.note}</div>` : ''}
                    </div>
                    <button onclick="removeExpenseBeadItem(${index})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                </div>
            `).join('');
        }
        
        function addExpenseBeadItem() {
            openExpenseBeadItemModal();
        }
        
        function confirmAddExpense() {
            const type = document.getElementById('expenseType').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const date = document.getElementById('expenseDate').value;
            const note = document.getElementById('expenseNote').value;
            
            if (amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼');
                return;
            }
            
            if (!date) {
                alert('è¯·é€‰æ‹©æ—¥æœŸï¼');
                return;
            }
            
            const expenses = JSON.parse(localStorage.getItem('perlerTimerExpenses')) || [];
            
            const expense = {
                id: generateId(),
                type: type,
                amount: amount,
                date: date,
                note: note,
                beads: currentExpenseBeads,
                createTime: new Date().toISOString()
            };
            
            expenses.push(expense);
            localStorage.setItem('perlerTimerExpenses', JSON.stringify(expenses));
            
            if (currentExpenseBeads.length > 0) {
                const beads = JSON.parse(localStorage.getItem('perlerTimerBeads')) || [];
                
                currentExpenseBeads.forEach(usage => {
                    const beadIndex = beads.findIndex(b => b.code === usage.code);
                    if (beadIndex !== -1) {
                        beads[beadIndex].stockGram += usage.amount;
                    }
                });
                
                localStorage.setItem('perlerTimerBeads', JSON.stringify(beads));
                
                const logs = JSON.parse(localStorage.getItem('perlerTimerInventoryLogs')) || [];
                logs.unshift({
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type: 'in',
                    colors: currentExpenseBeads.map(u => ({
                        code: u.code,
                        name: u.name,
                        gram: u.amount
                    })),
                    note: `æ”¯å‡ºè®°å½•ï¼š${getExpenseTypeName(type)}`,
                    expenseId: expense.id
                });
                localStorage.setItem('perlerTimerInventoryLogs', JSON.stringify(logs.slice(0, 500)));
            }
            
            closeAddExpenseModal();
            loadExpenses();
            updateStats();
            showNotification('æ”¯å‡ºæ·»åŠ æˆåŠŸï¼');
        }
        
        function deleteExpense(expenseId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ”¯å‡ºè®°å½•å—ï¼Ÿ')) return;
            
            let expenses = JSON.parse(localStorage.getItem('perlerTimerExpenses')) || [];
            expenses = expenses.filter(e => e.id !== expenseId);
            localStorage.setItem('perlerTimerExpenses', JSON.stringify(expenses));
            
            loadExpenses();
            updateStats();
            showNotification('æ”¯å‡ºåˆ é™¤æˆåŠŸï¼');
        }
        
        function exportData() {
            const orders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
            const expenses = JSON.parse(localStorage.getItem('perlerTimerExpenses') || '[]');
            
            const ordersData = orders.map(order => ({
                'è®¢å•ID': order.id,
                'æ¡Œä½': order.tableName,
                'å¼€å§‹æ—¶é—´': new Date(order.startTime).toLocaleString(),
                'ç»“æŸæ—¶é—´': new Date(order.endTime).toLocaleString(),
                'è®¡è´¹æ–¹å¼': order.chargeType === 'daily' ? 'åŒ…æ—¥è®¡è´¹' : order.chargeType === 'groupbuy' ? 'å›¢è´­å¥—é¤' : 'æŒ‰æ—¶é•¿è®¡è´¹',
                'å®¢æˆ·ç±»å‹': getCustomerTypeName(order.customerType),
                'åŸä»·': order.originalPrice.toFixed(2),
                'æŠ˜æ‰£': order.discount > 0 ? (order.discount * 100).toFixed(0) + '%' : 'æ— ',
                'åº”æ”¶é‡‘é¢': order.actualPayment.toFixed(2),
                'å¹³å°è´¹ç”¨': order.platformFee.toFixed(2),
                'å®é™…åˆ°è´¦': order.netIncome.toFixed(2),
                'æ—¥æœŸ': order.date
            }));
            
            const expensesData = expenses.map(expense => ({
                'æ”¯å‡ºID': expense.id,
                'ç±»å‹': getExpenseTypeName(expense.type),
                'é‡‘é¢': expense.amount.toFixed(2),
                'æ—¥æœŸ': expense.date,
                'å¤‡æ³¨': expense.note || '-'
            }));
            
            exportToCSV(ordersData, 'æ”¶å…¥è®°å½•');
            exportToCSV(expensesData, 'æ”¯å‡ºè®°å½•');
        }
        
        window.onload = initRevenueExpensePage;
    </script>
</body>
</html>