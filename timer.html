<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶è´¹ç®¡ç† - æ‹¼è±†è®¡æ—¶å™¨ Pro V1.0</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ‹¼è±†è®¡æ—¶å™¨">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <div class="app">
        <!-- ä¾§è¾¹å¯¼èˆªæ  -->
        <nav class="sidebar">
            <a href="index.html" class="logo">
                <h2 id="shopNameDisplay">ğŸ¨ æ‹¼è±†è®¡æ—¶å™¨</h2>
                <span class="version">V1.0</span>
            </a>
            
            <div class="nav-menu">
                <a href="timer.html" class="nav-item active">
                    <span class="icon">â±ï¸</span>
                    <span>æ”¶è´¹ç®¡ç†</span>
                </a>
                <a href="inventory.html" class="nav-item">
                    <span class="icon">ğŸ“¦</span>
                    <span>åº“å­˜ç®¡ç†</span>
                </a>
                <a href="revenue-expense.html" class="nav-item">
                    <span class="icon">ğŸ’°</span>
                    <span>æ”¶æ”¯ç®¡ç†</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <span class="icon">âš™ï¸</span>
                    <span>ç³»ç»Ÿè®¾ç½®</span>
                </a>
            </div>
        </nav>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <div class="timer-page">
                <div class="page-header">
                    <h1>â±ï¸ æ”¶è´¹ç®¡ç†</h1>
                    <div class="header-actions">
                        <input type="text" id="tableSearch" placeholder="æœç´¢æ¡Œä½..." class="search-input">
                        <button onclick="clearAllTables()" class="btn btn-danger">æ¸…ç©ºå…¨éƒ¨</button>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿç»Ÿè®¡å¡ç‰‡ -->
                <div class="quick-timer-stats">
                    <div class="stat-card">
                        <div class="stat-label">åœ¨çº¿æ¡Œä½</div>
                        <div class="stat-value" id="activeCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç©ºé—²æ¡Œä½</div>
                        <div class="stat-value" id="freeCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ä»Šæ—¥è®¢å•</div>
                        <div class="stat-value" id="todayOrderCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ä»Šæ—¥æ”¶å…¥</div>
                        <div class="stat-value" id="todayTotal">Â¥0.00</div>
                    </div>
                </div>
                
                <!-- æ¡Œä½åˆ—è¡¨ -->
                <div id="tableList" class="tables-grid"></div>
            </div>
        </main>
    </div>
    
    <!-- å¼€å§‹è®¡æ—¶å¼¹çª— -->
    <div id="startModal" class="modal">
        <div class="modal-content">
            <h2>å¼€å§‹è®¡æ—¶ - <span id="modalTableName"></span></h2>
            <div class="form-group">
                <label>è®¡è´¹æ–¹å¼</label>
                <select id="chargeType" class="form-control" onchange="toggleGroupBuyFields()">
                    <option value="hourly">æŒ‰æ—¶é•¿è®¡è´¹</option>
                    <option value="daily">åŒ…æ—¥è®¡è´¹</option>
                    <option value="groupbuy">å›¢è´­å¥—é¤ï¼ˆå›ºå®šä»·æ ¼ï¼‰</option>
                </select>
            </div>
            <div class="form-group" id="groupBuyPriceGroup" style="display: none;">
                <label>å›¢è´­ä»·æ ¼ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="groupBuyPrice" class="form-control" step="0.01" min="0" placeholder="ä¾‹å¦‚ï¼š39.9">
            </div>
            <div class="form-group">
                <label>ä¼šå‘˜æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰</label>
                <input type="tel" id="memberPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" class="form-control">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea id="startNote" class="form-control" placeholder="å¤‡æ³¨ä¿¡æ¯..."></textarea>
            </div>
            <div class="modal-actions">
                <button onclick="closeStartModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmStartTimer()" class="btn btn-primary">å¼€å§‹è®¡æ—¶</button>
            </div>
        </div>
    </div>
    
    <!-- ç»“è´¦å¼¹çª— -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2>ç»“è´¦ - <span id="checkoutTableName"></span></h2>
            
            <div class="form-group">
                <label>ğŸ”— åˆå¹¶ç»“ç®—å…¶ä»–æ¡Œä½</label>
                <div id="mergeTablesList" class="merge-tables-list"></div>
                <button onclick="openMergeTableModal()" class="btn btn-sm btn-primary" style="margin-top: 10px;">â• æ·»åŠ æ¡Œä½</button>
            </div>
            
            <div class="checkout-info">
                <div class="info-row">
                    <span>å¼€å§‹æ—¶é—´ï¼š</span>
                    <span id="checkoutStartTime">-</span>
                </div>
                <div class="info-row">
                    <span>ç»“æŸæ—¶é—´ï¼š</span>
                    <span id="checkoutEndTime">-</span>
                </div>
                <div class="info-row">
                    <span>ä½¿ç”¨æ—¶é•¿ï¼š</span>
                    <span id="checkoutDuration">-</span>
                </div>
                <div class="info-row">
                    <span>è®¡è´¹æ–¹å¼ï¼š</span>
                    <span id="checkoutChargeType">-</span>
                </div>
                <div class="info-row">
                    <span>å®¢æˆ·ç±»å‹ï¼š</span>
                    <span id="checkoutCustomerType">-</span>
                </div>
                <hr>
                <div class="info-row total">
                    <span>åŸä»·ï¼š</span>
                    <span id="checkoutOriginalPrice">Â¥0.00</span>
                </div>
                <div class="info-row discount">
                    <span>æŠ˜æ‰£ï¼š</span>
                    <span id="checkoutDiscount">æ— </span>
                </div>
                <div class="info-row platform-fee" id="platformFeeRow" style="display: none;">
                    <span>å¹³å°è´¹ç”¨ï¼š</span>
                    <span id="checkoutPlatformFee">Â¥0.00</span>
                </div>
                <div class="info-row total-final">
                    <span>åº”æ”¶é‡‘é¢ï¼š</span>
                    <span class="final-price" id="checkoutFinalPrice">Â¥0.00</span>
                </div>
                <div class="info-row net-income" id="netIncomeRow" style="display: none;">
                    <span>å®é™…åˆ°è´¦ï¼š</span>
                    <span class="net-income-value" id="checkoutNetIncome">Â¥0.00</span>
                </div>
            </div>
            <div class="form-group">
                <label>å®¢æˆ·ç±»å‹</label>
                <select id="checkoutCustomerTypeSelect" class="form-control" onchange="updateCheckoutPrice()">
                    <option value="normal">æ™®é€šå®¢æˆ·ï¼ˆæ— æŠ˜æ‰£ï¼‰</option>
                    <option value="member">ä¼šå‘˜ (9æŠ˜)</option>
                    <option value="vip">VIP (8æŠ˜)</option>
                    <option value="student">å­¦ç”Ÿ (85æŠ˜)</option>
                    <optgroup label="--- å›¢è´­å¹³å° ---">
                        <option value="meituan">ç¾å›¢å›¢è´­ (æ‰£15%)</option>
                        <option value="douyin">æŠ–éŸ³å›¢è´­ (æ‰£18%)</option>
                        <option value="dianping">å¤§ä¼—ç‚¹è¯„ (æ‰£12%)</option>
                        <option value="xiaohongshu">å°çº¢ä¹¦ (æ‰£10%)</option>
                        <option value="custom">å…¶ä»–å¹³å° (è‡ªå®šä¹‰)</option>
                    </optgroup>
                </select>
            </div>
                <div class="form-group">
                    <label>å®é™…æ”¶æ¬¾ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="actualPayment" class="form-control" step="0.01" min="0">
                </div>
                <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea id="checkoutNote" class="form-control" placeholder="å¤‡æ³¨ä¿¡æ¯..."></textarea>
            </div>
            
            <hr>
            
            <div class="form-group">
                <label> å…¶ä»–æ”¶è´¹é¡¹ç›®</label>
                <div id="otherChargesList" class="other-charges-list"></div>
                <button onclick="addOtherChargeItem()" class="btn btn-sm btn-warning" style="margin-top: 10px;">â• æ·»åŠ æ”¶è´¹é¡¹ç›®</button>
            </div>
            
            <div class="modal-actions">
                <button onclick="closeCheckoutModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmCheckout()" class="btn btn-primary">ç¡®è®¤æ”¶æ¬¾</button>
            </div>
        </div>
    </div>
    
    <!-- å…¶ä»–æ”¶è´¹é¡¹ç›®å¼¹çª— -->
    <div id="otherChargeChargesModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>ğŸ“¦ æ·»åŠ æ”¶è´¹é¡¹ç›®</h2>
            <div class="form-group">
                <label>é€‰æ‹©æ”¶è´¹é¡¹ç›®</label>
                <select id="otherChargeTypeSelect" class="form-control" onchange="onOtherChargeTypeChange()">
                    <option value="">è¯·é€‰æ‹©æ”¶è´¹é¡¹ç›®...</option>
                </select>
            </div>
            <div class="form-group" id="otherChargePriceGroup" style="display: none;">
                <label>ä»·æ ¼ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="otherChargePrice" class="form-control" step="0.01" min="0" placeholder="ä¾‹å¦‚ï¼š10.00">
            </div>
            <div class="form-group">
                <label>æ•°é‡</label>
                <input type="number" id="otherChargeQuantity" class="form-control" step="1" min="1" value="1" placeholder="æ•°é‡">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <input type="text" id="otherChargeNote" class="form-control" placeholder="å¤‡æ³¨ä¿¡æ¯...">
            </div>
            <div class="modal-actions">
                <button onclick="closeOtherChargeChargesModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmAddOtherChargeItem()" class="btn btn-success">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- åˆå¹¶æ¡Œä½å¼¹çª— -->
    <div id="mergeTableModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>ğŸ”— é€‰æ‹©è¦åˆå¹¶çš„æ¡Œä½</h2>
            <div id="mergeTableOptions" class="merge-table-options"></div>
            <div class="modal-actions">
                <button onclick="closeMergeTableModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmMergeTables()" class="btn btn-success">ç¡®è®¤åˆå¹¶</button>
            </div>
        </div>
    </div>
    
    
    <script src="bead-data.js"></script>
    <script src="common.js"></script>
    <script>
        // å½“å‰é€‰ä¸­çš„æ¡Œä½
        let selectedTable = null;
        
        // å½“å‰å…¶ä»–æ”¶è´¹é¡¹ç›®è®°å½•
        let currentOtherCharges = [];
        
        // å½“å‰åˆå¹¶çš„æ¡Œä½
        let mergedTables = [];
        
        // åˆå§‹åŒ–é¡µé¢
        function initTimerPage() {
            loadConfig();
            initTables(); // åˆå§‹åŒ–æ¡Œä½
            updateShopNameDisplay();
            loadTables();
            updateTimerStats();
            
            // æœç´¢åŠŸèƒ½
            document.getElementById('tableSearch').addEventListener('input', function() {
                loadTables(this.value);
            });
        }
        
        // åŠ è½½æ¡Œä½åˆ—è¡¨
        function loadTables(searchTerm = '') {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const container = document.getElementById('tableList');
            
            let filteredTables = tables;
            if (searchTerm) {
                filteredTables = tables.filter(table => 
                    table.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    table.customerPhone?.includes(searchTerm)
                );
            }
            
            container.innerHTML = filteredTables.map(table => `
                <div class="table-card ${table.status === 'in-use' ? 'busy' : 'free'}" data-id="${table.id}">
                    <div class="table-header">
                        <h3>${table.name}</h3>
                        <span class="table-status ${table.status}">
                            ${table.status === 'in-use' ? 'ä½¿ç”¨ä¸­' : 'ç©ºé—²'}
                        </span>
                    </div>
                    
                    ${table.status === 'in-use' ? `
                        <div class="table-timer">
                            <div class="timer-display" id="timer-${table.id}">
                                ${formatDuration(table.startTime)}
                            </div>
                            <div class="customer-info">
                                ${table.chargeType === 'daily' ? '<span class="charge-badge">åŒ…æ—¥</span>' : ''}
                                ${table.chargeType === 'groupbuy' ? '<span class="charge-badge" style="background: #f093fb;">å›¢è´­</span>' : ''}
                                ${table.customerPhone ? `<span class="phone">${table.customerPhone}</span>` : ''}
                            </div>
                            ${table.note ? `<div class="table-note">${table.note}</div>` : ''}
                        </div>
                        
                        <div class="table-cost">
                            <span>å½“å‰è´¹ç”¨ï¼š</span>
                            <span class="cost-value" id="cost-${table.id}">Â¥0.00</span>
                        </div>
                        
                        <div class="table-actions">
                            <button onclick="pauseResumeTimer('${table.id}')" class="btn ${table.paused ? 'btn-warning' : 'btn-info'}">
                                ${table.paused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ'}
                            </button>
                            <button onclick="openCheckoutModal('${table.id}')" class="btn btn-primary">
                                ğŸ’µ ç»“è´¦
                            </button>
                        </div>
                    ` : `
                        <div class="table-empty">
                            <p>æ¡Œä½ç©ºé—²</p>
                        </div>
                        <div class="table-actions">
                            <button onclick="openStartModal('${table.id}')" class="btn btn-success">
                                â±ï¸ å¼€å§‹è®¡æ—¶
                            </button>
                        </div>
                    `}
                </div>
            `).join('');
        }
        
        // åˆ‡æ¢å¹³å°è´¹ç‡æ˜¾ç¤ºï¼ˆV3.0æ–°å¢ï¼‰
        function togglePlatformFee() {
            const customerType = document.getElementById('customerType').value;
            const feeDisplay = document.getElementById('platformFeeDisplay');
            const platformTypes = ['meituan', 'douyin', 'dianping', 'xiaohongshu', 'custom'];
            
            if (platformTypes.includes(customerType)) {
                feeDisplay.style.display = 'block';
                const feeRate = getPlatformFeeRate(customerType) * 100;
                const platformName = config.platformFees && config.platformFees[customerType] ? config.platformFees[customerType].name : '';
                document.querySelector('.fee-rate').textContent = `${feeRate.toFixed(0)}%`;
                document.querySelector('.fee-desc').textContent = `${platformName}è´¹ç‡ï¼Œå®é™…åˆ°è´¦ = åŸä»· Ã— (1 - ${feeRate.toFixed(0)}%)`;
            } else {
                feeDisplay.style.display = 'none';
            }
        }
        
        // æ‰“å¼€å¼€å§‹è®¡æ—¶å¼¹çª—
        function openStartModal(tableId) {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            selectedTable = tables.find(t => t.id === tableId);
            
            if (selectedTable) {
                document.getElementById('modalTableName').textContent = selectedTable.name;
                document.getElementById('chargeType').value = 'hourly';
                document.getElementById('memberPhone').value = '';
                document.getElementById('startNote').value = '';
                
                document.getElementById('startModal').style.display = 'flex';
            }
        }
        
        function toggleGroupBuyFields() {
            const chargeType = document.getElementById('chargeType').value;
            const groupBuyPriceGroup = document.getElementById('groupBuyPriceGroup');
            groupBuyPriceGroup.style.display = chargeType === 'groupbuy' ? 'block' : 'none';
        }
        
        // å…³é—­å¼€å§‹è®¡æ—¶å¼¹çª—
        function closeStartModal() {
            document.getElementById('startModal').style.display = 'none';
            selectedTable = null;
        }
        
        // ç¡®è®¤å¼€å§‹è®¡æ—¶
        function confirmStartTimer() {
            if (!selectedTable) return;
            
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const tableIndex = tables.findIndex(t => t.id === selectedTable.id);
            
            if (tableIndex !== -1) {
                const chargeType = document.getElementById('chargeType').value;
                tables[tableIndex] = {
                    ...tables[tableIndex],
                    status: 'in-use',
                    startTime: Date.now(),
                    pauseTime: null,
                    paused: false,
                    chargeType: chargeType,
                    groupBuyPrice: chargeType === 'groupbuy' ? parseFloat(document.getElementById('groupBuyPrice').value) : null,
                    customerType: 'normal',
                    customerPhone: document.getElementById('memberPhone').value,
                    note: document.getElementById('startNote').value
                };
                
                localStorage.setItem('perlerTimerTables', JSON.stringify(tables));
                
                closeStartModal();
                loadTables();
                updateTimerStats();
                
                // é€šçŸ¥
                showNotification(`${selectedTable.name} è®¡æ—¶å·²å¼€å§‹`);
            }
        }
        
        // æš‚åœ/æ¢å¤è®¡æ—¶
        function pauseResumeTimer(tableId) {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const tableIndex = tables.findIndex(t => t.id === tableId);
            
            if (tableIndex !== -1) {
                if (tables[tableIndex].paused) {
                    // æ¢å¤è®¡æ—¶
                    const pauseDuration = Date.now() - tables[tableIndex].pauseTime;
                    tables[tableIndex] = {
                        ...tables[tableIndex],
                        startTime: tables[tableIndex].startTime + pauseDuration,
                        paused: false,
                        pauseTime: null
                    };
                } else {
                    // æš‚åœè®¡æ—¶
                    tables[tableIndex] = {
                        ...tables[tableIndex],
                        paused: true,
                        pauseTime: Date.now()
                    };
                }
                
                localStorage.setItem('perlerTimerTables', JSON.stringify(tables));
                loadTables();
            }
        }
        
        // æ‰“å¼€ç»“è´¦å¼¹çª—
        function openCheckoutModal(tableId) {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            selectedTable = tables.find(t => t.id === tableId);
            
            if (selectedTable) {
                document.getElementById('checkoutTableName').textContent = selectedTable.name;
                
                const now = Date.now();
                const duration = selectedTable.paused ? 
                    selectedTable.pauseTime - selectedTable.startTime : 
                    now - selectedTable.startTime;
                
                const hours = Math.floor(duration / (1000 * 60 * 60));
                const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('checkoutStartTime').textContent = 
                    new Date(selectedTable.startTime).toLocaleString();
                document.getElementById('checkoutEndTime').textContent = 
                    new Date(now).toLocaleString();
                document.getElementById('checkoutDuration').textContent = 
                    `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                document.getElementById('checkoutChargeType').textContent = 
                    selectedTable.chargeType === 'daily' ? 'åŒ…æ—¥è®¡è´¹' : 
                    selectedTable.chargeType === 'groupbuy' ? 'å›¢è´­å¥—é¤' : 'æŒ‰æ—¶é•¿è®¡è´¹';
                
                document.getElementById('checkoutCustomerTypeSelect').value = 'normal';
                
                updateCheckoutPrice();
                
                document.getElementById('checkoutNote').value = '';
                
                currentOtherCharges = [];
                updateOtherChargesList();
                
                mergedTables = [];
                updateMergeTablesList();
                
                document.getElementById('checkoutModal').style.display = 'flex';
            }
        }
        
        // æ›´æ–°ç»“è´¦ä»·æ ¼
        function updateCheckoutPrice() {
            const customerType = document.getElementById('checkoutCustomerTypeSelect').value;
            const discount = getDiscount(customerType);
            let originalPrice, finalPrice;
            
            if (selectedTable.chargeType === 'daily') {
                originalPrice = config.pricePerDay || 50;
                finalPrice = originalPrice * (1 - discount);
            } else if (selectedTable.chargeType === 'groupbuy') {
                originalPrice = selectedTable.groupBuyPrice || 0;
                finalPrice = originalPrice;
            } else {
                const now = Date.now();
                const duration = selectedTable.paused ? 
                    selectedTable.pauseTime - selectedTable.startTime : 
                    now - selectedTable.startTime;
                const billableHours = calculateBillableHours(duration);
                originalPrice = billableHours * (config.pricePerHour || 15);
                finalPrice = originalPrice * (1 - discount);
            }
            
            // è®¡ç®—åˆå¹¶æ¡Œä½çš„è´¹ç”¨
            let mergedTablesPrice = 0;
            let mergedTablesDiscountedPrice = 0;
            mergedTables.forEach(table => {
                let tablePrice = 0;
                if (table.chargeType === 'daily') {
                    tablePrice = config.pricePerDay || 50;
                    mergedTablesDiscountedPrice += tablePrice * (1 - discount);
                } else if (table.chargeType === 'groupbuy') {
                    tablePrice = table.groupBuyPrice || 0;
                    mergedTablesDiscountedPrice += tablePrice;
                } else {
                    const now = Date.now();
                    const duration = table.paused ? 
                        table.pauseTime - table.startTime : 
                        now - table.startTime;
                    const billableHours = calculateBillableHours(duration);
                    tablePrice = billableHours * (config.pricePerHour || 15);
                    mergedTablesDiscountedPrice += tablePrice * (1 - discount);
                }
                mergedTablesPrice += tablePrice;
            });
            
            const totalOriginalPrice = originalPrice + mergedTablesPrice;
            const totalFinalPrice = finalPrice + mergedTablesDiscountedPrice;
            
            // è®¡ç®—å¹³å°è´¹ç”¨
            const platformFeeRate = getPlatformFeeRate(customerType);
            const platformFee = platformFeeRate > 0 ? totalFinalPrice * platformFeeRate : 0;
            const netIncome = platformFeeRate > 0 ? totalFinalPrice - platformFee : totalFinalPrice;
            const isPlatform = platformFeeRate > 0;
            
            document.getElementById('checkoutCustomerType').textContent = 
                getCustomerTypeName(customerType);
            document.getElementById('checkoutOriginalPrice').textContent = 
                `Â¥${totalOriginalPrice.toFixed(2)}`;
            document.getElementById('checkoutDiscount').textContent = 
                discount > 0 ? `${(discount * 100).toFixed(0)}%` : 'æ— ';
            
            if (isPlatform) {
                document.getElementById('platformFeeRow').style.display = 'flex';
                document.getElementById('checkoutPlatformFee').textContent = `Â¥${platformFee.toFixed(2)} (${(platformFeeRate * 100).toFixed(0)}%)`;
                document.getElementById('netIncomeRow').style.display = 'flex';
                document.getElementById('checkoutNetIncome').textContent = `Â¥${netIncome.toFixed(2)}`;
            } else {
                document.getElementById('platformFeeRow').style.display = 'none';
                document.getElementById('netIncomeRow').style.display = 'none';
            }
            
            const otherChargesTotal = currentOtherCharges.reduce((sum, item) => sum + item.total, 0);
            const totalPrice = totalFinalPrice + otherChargesTotal;
            
            document.getElementById('checkoutFinalPrice').textContent = 
                `Â¥${totalPrice.toFixed(2)}`;
            document.getElementById('actualPayment').value = totalPrice.toFixed(2);
        }
        
        // å…³é—­ç»“è´¦å¼¹çª—
        function closeCheckoutModal() {
            document.getElementById('checkoutModal').style.display = 'none';
            selectedTable = null;
            currentOtherCharges = [];
        }
        
        // è·å–å…¶ä»–æ”¶è´¹é¡¹ç›®é…ç½®
        function getOtherChargeItems() {
            return config.otherChargeItems || [];
        }
        
        // åŠ è½½å…¶ä»–æ”¶è´¹é¡¹ç›®é€‰æ‹©å™¨
        function loadOtherChargeTypeSelect() {
            const items = getOtherChargeItems();
            const select = document.getElementById('otherChargeTypeSelect');
            
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ”¶è´¹é¡¹ç›®...</option>';
            items.filter(item => item.enabled).forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (Â¥${item.price.toFixed(2)}/${item.unit})`;
                select.appendChild(option);
            });
        }
        
        // å…¶ä»–æ”¶è´¹é¡¹ç›®ç±»å‹å˜åŒ–
        function onOtherChargeTypeChange() {
            const select = document.getElementById('otherChargeTypeSelect');
            const priceGroup = document.getElementById('otherChargePriceGroup');
            const priceInput = document.getElementById('otherChargePrice');
            
            if (select.value) {
                const items = getOtherChargeItems();
                const item = items.find(i => i.id === parseInt(select.value));
                
                if (item && item.price > 0) {
                    priceInput.value = item.price.toFixed(2);
                    priceGroup.style.display = 'none';
                } else {
                    priceInput.value = '';
                    priceGroup.style.display = 'block';
                }
            } else {
                priceInput.value = '';
                priceGroup.style.display = 'none';
            }
        }
        
        // æ‰“å¼€å…¶ä»–æ”¶è´¹é¡¹ç›®å¼¹çª—
        function openOtherChargeChargesModal() {
            loadOtherChargeTypeSelect();
            document.getElementById('otherChargeTypeSelect').value = '';
            document.getElementById('otherChargePrice').value = '';
            document.getElementById('otherChargeQuantity').value = '1';
            document.getElementById('otherChargeNote').value = '';
            document.getElementById('otherChargePriceGroup').style.display = 'none';
            document.getElementById('otherChargeChargesModal').style.display = 'flex';
        }
        
        // å…³é—­å…¶ä»–æ”¶è´¹é¡¹ç›®å¼¹çª—
        function closeOtherChargeChargesModal() {
            document.getElementById('otherChargeChargesModal').style.display = 'none';
        }
        
        // ç¡®è®¤æ·»åŠ å…¶ä»–æ”¶è´¹é¡¹ç›®
        function confirmAddOtherChargeItem() {
            const typeId = document.getElementById('otherChargeTypeSelect').value;
            const price = parseFloat(document.getElementById('otherChargePrice').value) || 0;
            const quantity = parseInt(document.getElementById('otherChargeQuantity').value) || 1;
            const note = document.getElementById('otherChargeNote').value;
            
            if (!typeId) {
                alert('è¯·é€‰æ‹©æ”¶è´¹é¡¹ç›®ï¼');
                return;
            }
            
            if (price <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼');
                return;
            }
            
            if (quantity <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡ï¼');
                return;
            }
            
            const items = getOtherChargeItems();
            const item = items.find(i => i.id === parseInt(typeId));
            
            if (!item) {
                alert('æ”¶è´¹é¡¹ç›®ä¸å­˜åœ¨ï¼');
                return;
            }
            
            currentOtherCharges.push({
                typeId: item.id,
                name: item.name,
                unit: item.unit,
                price: price,
                quantity: quantity,
                total: price * quantity,
                note: note
            });
            
            updateOtherChargesList();
            closeOtherChargeChargesModal();
        }
        
        // åˆ é™¤å…¶ä»–æ”¶è´¹é¡¹ç›®
        function removeOtherChargeItem(index) {
            currentOtherCharges.splice(index, 1);
            updateOtherChargesList();
        }
        
        // æ›´æ–°å…¶ä»–æ”¶è´¹é¡¹ç›®åˆ—è¡¨æ˜¾ç¤º
        function updateOtherChargesList() {
            const container = document.getElementById('otherChargesList');
            
            if (currentOtherCharges.length === 0) {
                container.innerHTML = '<div class="empty-hint">æš‚æ— å…¶ä»–æ”¶è´¹é¡¹ç›®</div>';
                return;
            }
            
            container.innerHTML = currentOtherCharges.map((item, index) => `
                <div class="other-charge-item">
                    <div class="other-charge-info">
                        <div class="other-charge-name">${item.name}</div>
                        <div class="other-charge-detail">Â¥${item.price.toFixed(2)} Ã— ${item.quantity}${item.unit}</div>
                        ${item.note ? `<div class="other-charge-note">${item.note}</div>` : ''}
                    </div>
                    <div class="other-charge-total">Â¥${item.total.toFixed(2)}</div>
                    <button onclick="removeOtherChargeItem(${index})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                </div>
            `).join('');
        }
        
       
        
        // æ·»åŠ å…¶ä»–æ”¶è´¹é¡¹ç›®ï¼ˆæŒ‰é’®è°ƒç”¨ï¼‰
        function addOtherChargeItem() {
            openOtherChargeChargesModal();
        }
        
        // æ‰“å¼€åˆå¹¶æ¡Œä½å¼¹çª—
        function openMergeTableModal() {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const inUseTables = tables.filter(t => t.status === 'in-use' && t.id !== selectedTable.id);
            
            const container = document.getElementById('mergeTableOptions');
            
            if (inUseTables.length === 0) {
                container.innerHTML = '<div class="empty-hint">æ²¡æœ‰å…¶ä»–æ­£åœ¨ä½¿ç”¨çš„æ¡Œä½</div>';
            } else {
                container.innerHTML = inUseTables.map(table => `
                    <label class="merge-table-option">
                        <input type="checkbox" value="${table.id}" 
                            ${mergedTables.some(m => m.id === table.id) ? 'checked' : ''}>
                        <span class="table-name">${table.name}</span>
                        <span class="table-time">${formatDuration(Date.now() - table.startTime)}</span>
                    </label>
                `).join('');
            }
            
            document.getElementById('mergeTableModal').style.display = 'flex';
        }
        
        // å…³é—­åˆå¹¶æ¡Œä½å¼¹çª—
        function closeMergeTableModal() {
            document.getElementById('mergeTableModal').style.display = 'none';
        }
        
        // ç¡®è®¤åˆå¹¶æ¡Œä½
        function confirmMergeTables() {
            const checkboxes = document.querySelectorAll('#mergeTableOptions input[type="checkbox"]');
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            
            mergedTables = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const table = tables.find(t => t.id === checkbox.value);
                    if (table) {
                        mergedTables.push(table);
                    }
                }
            });
            
            updateMergeTablesList();
            updateCheckoutPrice();
            closeMergeTableModal();
        }
        
        // ç§»é™¤åˆå¹¶çš„æ¡Œä½
        function removeMergedTable(tableId) {
            mergedTables = mergedTables.filter(t => t.id !== tableId);
            updateMergeTablesList();
            updateCheckoutPrice();
        }
        
        // æ›´æ–°åˆå¹¶æ¡Œä½åˆ—è¡¨æ˜¾ç¤º
        function updateMergeTablesList() {
            const container = document.getElementById('mergeTablesList');
            
            if (mergedTables.length === 0) {
                container.innerHTML = '<div class="empty-hint">æš‚æ— åˆå¹¶æ¡Œä½</div>';
                return;
            }
            
            container.innerHTML = mergedTables.map(table => `
                <div class="merge-table-item">
                    <div class="merge-table-info">
                        <div class="merge-table-name">${table.name}</div>
                        <div class="merge-table-time">${formatDuration(Date.now() - table.startTime)}</div>
                    </div>
                    <button onclick="removeMergedTable('${table.id}')" class="btn btn-sm btn-danger">ç§»é™¤</button>
                </div>
            `).join('');
        }
        
        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
        }
        
        // ç¡®è®¤ç»“è´¦
        function confirmCheckout() {
            if (!selectedTable) return;
            
            const actualPayment = parseFloat(document.getElementById('actualPayment').value) || 0;
            const note = document.getElementById('checkoutNote').value;
            
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const tableIndex = tables.findIndex(t => t.id === selectedTable.id);
            
            if (tableIndex !== -1) {
                const endTime = Date.now();
                const duration = tables[tableIndex].paused ? 
                    tables[tableIndex].pauseTime - tables[tableIndex].startTime : 
                    endTime - tables[tableIndex].startTime;
                
                const discount = getDiscount(tables[tableIndex].customerType);
                let originalPrice, calculatedPrice;
                
                if (tables[tableIndex].chargeType === 'daily') {
                    originalPrice = config.pricePerDay || 50;
                    calculatedPrice = originalPrice * (1 - discount);
                } else if (tables[tableIndex].chargeType === 'groupbuy') {
                    originalPrice = tables[tableIndex].groupBuyPrice || 0;
                    calculatedPrice = originalPrice;
                } else {
                    const hoursUsed = duration / (1000 * 60 * 60);
                    originalPrice = hoursUsed * (config.pricePerHour || 15);
                    calculatedPrice = originalPrice * (1 - discount);
                }
                
                // è®¡ç®—åˆå¹¶æ¡Œä½çš„è´¹ç”¨
                let mergedTablesPrice = 0;
                let mergedTablesDiscountedPrice = 0;
                mergedTables.forEach(table => {
                    let tablePrice = 0;
                    if (table.chargeType === 'daily') {
                        tablePrice = config.pricePerDay || 50;
                        mergedTablesDiscountedPrice += tablePrice * (1 - discount);
                    } else if (table.chargeType === 'groupbuy') {
                        tablePrice = table.groupBuyPrice || 0;
                        mergedTablesDiscountedPrice += tablePrice;
                    } else {
                        const now = Date.now();
                        const tableDuration = table.paused ? 
                            table.pauseTime - table.startTime : 
                            now - table.startTime;
                        const billableHours = calculateBillableHours(tableDuration);
                        tablePrice = billableHours * (config.pricePerHour || 15);
                        mergedTablesDiscountedPrice += tablePrice * (1 - discount);
                    }
                    mergedTablesPrice += tablePrice;
                });
                
                const totalOriginalPrice = originalPrice + mergedTablesPrice;
                const totalCalculatedPrice = calculatedPrice + mergedTablesDiscountedPrice;
                
                // è®¡ç®—å…¶ä»–æ”¶è´¹é¡¹ç›®
                const otherChargesTotal = currentOtherCharges.reduce((sum, item) => sum + item.total, 0);
                
                const finalCalculatedPrice = totalCalculatedPrice + otherChargesTotal;
                
                // è®¡ç®—å¹³å°è´¹ç”¨ï¼ˆV3.0æ–°å¢ï¼‰
                const platformFeeRate = getPlatformFeeRate(tables[tableIndex].customerType);
                const platformFee = platformFeeRate > 0 ? finalCalculatedPrice * platformFeeRate : 0;
                const netIncome = platformFeeRate > 0 ? finalCalculatedPrice - platformFee : finalCalculatedPrice;
                
                // åˆ›å»ºè®¢å•è®°å½•
                const orders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
                const order = {
                    id: generateId(),
                    tableId: selectedTable.id,
                    tableName: selectedTable.name,
                    startTime: tables[tableIndex].startTime,
                    endTime: endTime,
                    duration: duration,
                    chargeType: tables[tableIndex].chargeType || 'hourly',
                    customerType: tables[tableIndex].customerType,
                    customerPhone: tables[tableIndex].customerPhone,
                    note: tables[tableIndex].note,
                    originalPrice: totalOriginalPrice,
                    discount: discount,
                    calculatedPrice: totalCalculatedPrice,
                    // V3.0æ–°å¢å¹³å°è´¹ç”¨å­—æ®µ
                    platformFeeRate: platformFeeRate,
                    platformFee: platformFee,
                    netIncome: netIncome,
                    actualPayment: actualPayment,
                    checkoutNote: note,
                    // å…¶ä»–æ”¶è´¹é¡¹ç›®è®°å½•
                    otherCharges: currentOtherCharges,
                    otherChargesTotal: otherChargesTotal,
                    // åˆå¹¶æ¡Œä½ä¿¡æ¯
                    mergedTables: mergedTables.map(t => ({ id: t.id, name: t.name })),
                    date: new Date().toISOString().split('T')[0],
                    createTime: new Date().toISOString()
                };
                
                orders.push(order);
                localStorage.setItem('perlerTimerOrders', JSON.stringify(orders));
                
                // æ¸…ç©ºåˆå¹¶çš„æ¡Œä½
                mergedTables.forEach(mergedTable => {
                    const mergedIndex = tables.findIndex(t => t.id === mergedTable.id);
                    if (mergedIndex !== -1) {
                        tables[mergedIndex] = {
                            ...tables[mergedIndex],
                            status: 'free',
                            startTime: null,
                            pauseTime: null,
                            paused: false,
                            chargeType: null,
                            customerType: null,
                            customerPhone: null,
                            note: null
                        };
                    }
                });
                
                // æ¸…ç©ºä¸»æ¡Œä½
                tables[tableIndex] = {
                    ...tables[tableIndex],
                    status: 'free',
                    startTime: null,
                    pauseTime: null,
                    paused: false,
                    chargeType: null,
                    customerType: null,
                    customerPhone: null,
                    note: null
                };
                
                localStorage.setItem('perlerTimerTables', JSON.stringify(tables));
                
                closeCheckoutModal();
                loadTables();
                updateTimerStats();
                
                // é€šçŸ¥
                const notificationText = platformFeeRate > 0 ? 
                    `${selectedTable.name} ç»“è´¦æˆåŠŸï¼Œåº”æ”¶ Â¥${actualPayment.toFixed(2)}ï¼Œå®é™…åˆ°è´¦ Â¥${netIncome.toFixed(2)}` :
                    `${selectedTable.name} ç»“è´¦æˆåŠŸï¼Œæ”¶æ¬¾ Â¥${actualPayment.toFixed(2)}`;
                showNotification(notificationText);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ¡Œä½
        function clearAllTables() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¡Œä½å—ï¼Ÿæ‰€æœ‰è®¡æ—¶è®°å½•å°†ä¸¢å¤±ï¼')) {
                const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
                tables.forEach(table => {
                    table.status = 'free';
                    table.startTime = null;
                    table.pauseTime = null;
                    table.paused = false;
                    table.chargeType = null;
                    table.customerType = null;
                    table.customerPhone = null;
                    table.note = null;
                });
                
                localStorage.setItem('perlerTimerTables', JSON.stringify(tables));
                loadTables();
                updateTimerStats();
            }
        }
        
        // æ›´æ–°è®¡æ—¶ç»Ÿè®¡
        function updateTimerStats() {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const orders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
            
            const todayOrders = orders.filter(o => o.date === today);
            const activeCount = tables.filter(t => t.status === 'in-use').length;
            
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('freeCount').textContent = tables.length - activeCount;
            document.getElementById('todayOrderCount').textContent = todayOrders.length;
            document.getElementById('todayTotal').textContent = 
                `Â¥${todayOrders.reduce((sum, o) => sum + o.actualPayment, 0).toFixed(2)}`;
        }
        
        // æ›´æ–°æ‰€æœ‰æ¡Œä½çš„è®¡æ—¶æ˜¾ç¤º
        function updateAllTimers() {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            
            tables.filter(t => t.status === 'in-use').forEach(table => {
                const timerEl = document.getElementById(`timer-${table.id}`);
                const costEl = document.getElementById(`cost-${table.id}`);
                
                if (timerEl && costEl) {
                    const now = Date.now();
                    const duration = table.paused ? 
                        table.pauseTime - table.startTime : 
                        now - table.startTime;
                    
                    timerEl.textContent = formatDuration(duration);
                    
                    if (table.chargeType === 'daily') {
                        const discount = getDiscount(table.customerType);
                        const dailyPrice = (config.pricePerDay || 50) * (1 - discount);
                        costEl.textContent = `Â¥${dailyPrice.toFixed(2)}`;
                    } else if (table.chargeType === 'groupbuy') {
                        const groupBuyPrice = table.groupBuyPrice || 0;
                        costEl.textContent = `Â¥${groupBuyPrice.toFixed(2)}`;
                    } else {
                        const discount = getDiscount(table.customerType);
                        const billableHours = calculateBillableHours(duration);
                        const pricePerHour = config.pricePerHour || 15;
                        const cost = billableHours * pricePerHour * (1 - discount);
                        costEl.textContent = `Â¥${cost.toFixed(2)}`;
                    }
                }
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', initTimerPage);
        
        // æ¯ç§’æ›´æ–°è®¡æ—¶
        setInterval(updateAllTimers, 1000);
    </script>
</body>
</html>
