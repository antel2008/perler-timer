<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»“ç®—ç»Ÿè®¡ - æ‹¼è±†è®¡æ—¶å™¨ Pro V1.0</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ‹¼è±†è®¡æ—¶å™¨">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <div class="app">
        <nav class="sidebar">
            <a href="index.html" class="logo">
                <h2 id="shopNameDisplay">æ‹¼è±†è®¡æ—¶å™¨</h2>
                <span class="version">V1.0</span>
            </a>
            
            <div class="nav-menu">
                <a href="timer.html" class="nav-item">
                    <span class="icon">â±ï¸</span>
                    <span>è®¡æ—¶ç®¡ç†</span>
                </a>
                <a href="inventory.html" class="nav-item">
                    <span class="icon">ğŸ“¦</span>
                    <span>åº“å­˜ç®¡ç†</span>
                </a>
                <a href="expense.html" class="nav-item">
                    <span class="icon">ğŸ’°</span>
                    <span>è´¹ç”¨ç®¡ç†</span>
                </a>
                <a href="settlement.html" class="nav-item active">
                    <span class="icon">ğŸ“Š</span>
                    <span>ç»“ç®—ç»Ÿè®¡</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <span class="icon">âš™ï¸</span>
                    <span>ç³»ç»Ÿè®¾ç½®</span>
                </a>
            </div>
        </nav>
        
        <main class="main-content">
            <div class="settlement-page">
                <div class="page-header">
                    <h1>ğŸ“Š ç»“ç®—ç»Ÿè®¡</h1>
                    <div class="header-actions">
                        <button onclick="exportSettlements()" class="btn btn-secondary">ğŸ“¤ å¯¼å‡ºæŠ¥è¡¨</button>
                    </div>
                </div>
                
                <!-- ç»Ÿè®¡å¡ç‰‡ï¼ˆç´§å‡‘ç‰ˆï¼‰ -->
                <div class="settlement-stats-compact">
                    <div class="stat-card compact">
                        <div class="stat-label">ä»Šæ—¥è®¢å•</div>
                        <div class="stat-value" id="todayOrders">0</div>
                    </div>
                    <div class="stat-card compact">
                        <div class="stat-label">ä»Šæ—¥æ”¶å…¥</div>
                        <div class="stat-value" id="todayIncome">Â¥0.00</div>
                    </div>
                    <div class="stat-card compact">
                        <div class="stat-label">ä»Šæ—¥å¹³å°è´¹</div>
                        <div class="stat-value" id="todayPlatformFee" style="color: #e74c3c;">Â¥0.00</div>
                    </div>
                    <div class="stat-card compact">
                        <div class="stat-label">ä»Šæ—¥å®æ”¶</div>
                        <div class="stat-value" id="todayNetIncome" style="color: #27ae60;">Â¥0.00</div>
                    </div>
                    <div class="stat-card compact">
                        <div class="stat-label">æœ¬æœˆæ”¶å…¥</div>
                        <div class="stat-value" id="monthIncome">Â¥0.00</div>
                    </div>
                    <div class="stat-card compact">
                        <div class="stat-label">æ€»æ”¶å…¥</div>
                        <div class="stat-value" id="totalIncome">Â¥0.00</div>
                    </div>
                </div>
                
                <!-- ç­›é€‰åŒºï¼ˆç´§å‡‘ç‰ˆï¼‰ -->
                <div class="filter-section-compact">
                    <div class="filter-group">
                        <label>æ—¥æœŸï¼š</label>
                        <input type="date" id="settlementDateFilter" class="form-control compact" onchange="loadSettlements()">
                    </div>
                    <div class="filter-group">
                        <label>æ¡Œä½ï¼š</label>
                        <select id="settlementTableFilter" class="form-control compact" onchange="loadSettlements()">
                            <option value="all">å…¨éƒ¨</option>
                        </select>
                    </div>
                </div>
                
                <!-- è®¢å•åˆ—è¡¨ -->
                <div id="settlementList" class="settlement-list-compact"></div>
            </div>
        </main>
    </div>
    
    <script src="bead-data.js"></script>
    <script src="common.js"></script>
    <script src="csv-export.js"></script>
    <script>
        // åˆå§‹åŒ–é¡µé¢
        function initSettlementPage() {
            loadConfig();
            initTables();
            updateShopNameDisplay();
            loadSettlements();
            loadTableFilter();
        }
        
        // åŠ è½½æ¡Œä½ç­›é€‰
        function loadTableFilter() {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const select = document.getElementById('settlementTableFilter');
            
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = table.name;
                select.appendChild(option);
            });
        }
        
        // åŠ è½½ç»“ç®—åˆ—è¡¨
        function loadSettlements() {
            const dateFilter = document.getElementById('settlementDateFilter').value;
            const tableFilter = document.getElementById('settlementTableFilter').value;
            const container = document.getElementById('settlementList');
            
            let orders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
            
            // æŒ‰æ—¥æœŸç­›é€‰
            if (dateFilter) {
                orders = orders.filter(o => o.date === dateFilter);
            }
            
            // æŒ‰æ¡Œä½ç­›é€‰
            if (tableFilter !== 'all') {
                orders = orders.filter(o => o.tableId === tableFilter);
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            orders.sort((a, b) => new Date(b.createTime) - new Date(a.createTime));
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="empty-hint">æš‚æ— è®¢å•è®°å½•</div>';
                updateSettlementStats([]);
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const duration = order.duration;
                const hours = Math.floor(duration / (1000 * 60 * 60));
                const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                
                return `
                    <div class="order-card compact">
                        <div class="order-header">
                            <span class="order-table">${order.tableName}</span>
                            <span class="order-date">${order.date}</span>
                        </div>
                        <div class="order-detail">
                            <span>æ—¶é•¿ï¼š</span>
                            <span>${hours}å°æ—¶${minutes}åˆ†é’Ÿ</span>
                        </div>
                        <div class="order-detail">
                            <span>è®¡è´¹ï¼š</span>
                            <span>${order.chargeType === 'daily' ? 'åŒ…æ—¥' : 'æ—¶é•¿'}</span>
                        </div>
                        <div class="order-detail">
                            <span>å®¢æˆ·ï¼š</span>
                            <span>${getCustomerTypeName(order.customerType)}</span>
                        </div>
                        <div class="order-detail">
                            <span>åŸä»·ï¼š</span>
                            <span>Â¥${order.originalPrice.toFixed(2)}</span>
                        </div>
                        <div class="order-detail">
                            <span>æŠ˜æ‰£ï¼š</span>
                            <span>${order.discount > 0 ? (order.discount * 100).toFixed(0) + '%' : 'æ— '}</span>
                        </div>
                        ${order.platformFee && order.platformFee > 0 ? `
                            <div class="order-detail" style="color: #f39c12;">
                                <span>å¹³å°è´¹ï¼š</span>
                                <span>Â¥${order.platformFee.toFixed(2)} (${(order.platformFeeRate * 100).toFixed(0)}%)</span>
                            </div>
                            <div class="order-detail" style="color: #27ae60; font-weight: 600;">
                                <span>å®æ”¶ï¼š</span>
                                <span>Â¥${order.netIncome.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        ${order.beadUsage && order.beadUsage.length > 0 ? `
                            <div class="order-bead-usage">
                                <div class="order-bead-usage-header">
                                    <span>ğŸ¨ æ‹¼è±†ä½¿ç”¨</span>
                                    <span class="bead-total">${order.beadUsageTotal || order.beadUsage.reduce((sum, u) => sum + u.amount, 0)}g</span>
                                </div>
                                <div class="order-bead-usage-list">
                                    ${order.beadUsage.map(usage => `
                                        <div class="order-bead-usage-item">
                                            <span class="bead-code" style="background-color: ${usage.color};">${usage.code}</span>
                                            <span class="bead-name">${usage.name}</span>
                                            <span class="bead-amount">${usage.amount}g</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div class="order-total">
                            <span>åº”æ”¶ï¼š</span>
                            <span class="total-amount">Â¥${order.calculatedPrice.toFixed(2)}</span>
                        </div>
                        <div class="order-total actual">
                            <span>å®æ”¶ï¼š</span>
                            <span class="total-amount">Â¥${order.actualPayment.toFixed(2)}</span>
                        </div>
                        ${order.note || order.checkoutNote ? `
                            <div class="order-notes">
                                ${order.note ? `<div>å¤‡æ³¨ï¼š${order.note}</div>` : ''}
                                ${order.checkoutNote ? `<div>ç»“è´¦å¤‡æ³¨ï¼š${order.checkoutNote}</div>` : ''}
                            </div>
                        ` : ''}
                        <div class="order-actions">
                            <button onclick="deleteOrder('${order.id}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateSettlementStats(orders);
        }
        
        // æ›´æ–°ç»“ç®—ç»Ÿè®¡
        function updateSettlementStats(filteredOrders) {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = today.substring(0, 7);
            
            const allOrders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
            
            const todayOrders = allOrders.filter(o => o.date === today);
            const monthOrders = allOrders.filter(o => o.date.startsWith(currentMonth));
            
            const todayIncome = todayOrders.reduce((sum, o) => sum + o.actualPayment, 0);
            const todayPlatformFee = todayOrders.reduce((sum, o) => sum + (o.platformFee || 0), 0);
            const todayNetIncome = todayOrders.reduce((sum, o) => sum + (o.netIncome || o.actualPayment), 0);
            const monthIncome = monthOrders.reduce((sum, o) => sum + o.actualPayment, 0);
            const totalIncome = allOrders.reduce((sum, o) => sum + o.actualPayment, 0);
            
            document.getElementById('todayOrders').textContent = todayOrders.length;
            document.getElementById('todayIncome').textContent = `Â¥${todayIncome.toFixed(2)}`;
            document.getElementById('todayPlatformFee').textContent = `Â¥${todayPlatformFee.toFixed(2)}`;
            document.getElementById('todayNetIncome').textContent = `Â¥${todayNetIncome.toFixed(2)}`;
            document.getElementById('monthIncome').textContent = `Â¥${monthIncome.toFixed(2)}`;
            document.getElementById('totalIncome').textContent = `Â¥${totalIncome.toFixed(2)}`;
        }
        
        // åˆ é™¤è®¢å•
        function deleteOrder(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®¢å•å—ï¼Ÿ')) {
                const orders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
                const filteredOrders = orders.filter(o => o.id !== id);
                localStorage.setItem('perlerTimerOrders', JSON.stringify(filteredOrders));
                
                loadSettlements();
                showNotification('è®¢å•å·²åˆ é™¤');
            }
        }
        
        // å¯¼å‡ºæŠ¥è¡¨
        function exportSettlements() {
            exportOrdersCSV();
            showNotification('è®¢å•æŠ¥è¡¨å·²å¯¼å‡ºï¼ˆCSVæ ¼å¼ï¼ŒExcelå¯ç›´æ¥æ‰“å¼€ï¼‰');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', initSettlementPage);
    </script>
</body>
</html>
