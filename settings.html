<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè®¾ç½® - æ‹¼è±†è®¡æ—¶å™¨ Pro V1.0</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="color-styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ‹¼è±†è®¡æ—¶å™¨">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        /* è®¾ç½®é¡µé¢ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .settings-page {
                padding: 15px 12px 90px 12px !important;
            }
            
            .page-header h1 {
                font-size: 24px !important;
                margin-bottom: 20px;
            }
            
            .settings-section {
                padding: 18px 15px !important;
                border-radius: 12px;
                margin-bottom: 20px;
            }
            
            .settings-section h2 {
                font-size: 18px !important;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 18px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            /* åº—é“ºå›¾æ ‡ä¸Šä¼ åŒºç§»åŠ¨ç«¯ä¼˜åŒ– */
            .icon-upload-area {
                text-align: center;
            }
            
            .icon-preview {
                width: 60px;
                height: 60px;
                margin: 0 auto 15px;
            }
            
            .icon-actions {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .icon-actions input,
            .icon-actions button {
                width: 100%;
                padding: 12px;
                font-size: 14px;
            }
            
            /* æ¡Œä½æ“ä½œè¡Œç§»åŠ¨ç«¯ä¼˜åŒ– */
            .table-actions-row {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .table-actions-row .btn {
                width: 100%;
                padding: 12px;
            }
            
            /* æ¡Œä½åˆ—è¡¨ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .table-list-mini {
                margin: 15px 0;
            }
            
            .table-grid-three-columns {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 10px;
            }
            
            .table-mini {
                padding: 10px 8px;
            }
            
            .table-mini .table-name {
                font-size: 12px;
            }
            
            .table-mini .table-status {
                font-size: 10px;
            }
            
            /* è´¹ç”¨åˆ†æ‘Šè¡¨æ ¼ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .partner-table,
            .user-table,
            .charge-items-table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .partner-table th,
            .partner-table td,
            .user-table th,
            .user-table td,
            .charge-items-table th,
            .charge-items-table td {
                padding: 10px 8px;
                white-space: nowrap;
            }
            
            /* æ·»åŠ ç”¨æˆ·å’Œåˆä¼™äººè¾“å…¥ç½‘æ ¼ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .settings-section form[style*="grid-template-columns"] {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .settings-section form[style*="grid-template-columns"] input,
            .settings-section form[style*="grid-template-columns"] select,
            .settings-section form[style*="grid-template-columns"] button {
                width: 100%;
            }
            
            /* è®¾ç½®æ“ä½œæŒ‰é’®ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .settings-actions {
                margin-top: 20px;
                padding: 0 15px;
            }
            
            .settings-actions .btn {
                width: 100%;
                padding: 14px;
                font-size: 15px;
            }
            
            /* æ¨¡æ€æ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                margin: 0 !important;
                padding: 20px !important;
                max-width: 100%;
                border-radius: 12px;
            }
            
            .modal-content h2 {
                font-size: 20px !important;
                margin-bottom: 15px;
            }
            
            .modal-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
            
            /* å¼¹çª—ä¸­çš„è¡¨å•ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .modal-content .form-group label {
                font-size: 14px;
            }
            
            .modal-content .form-control {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            /* é¢œè‰²ç®¡ç†åˆ—è¡¨ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .color-manage-list {
                grid-template-columns: 1fr !important;
            }
            
            .color-manage-item {
                padding: 12px;
            }
            
            .color-manage-preview {
                width: 40px;
                height: 40px;
                font-size: 12px;
            }
            
            .color-manage-name {
                font-size: 14px;
            }
            
            .color-manage-details {
                font-size: 11px;
            }
            
            .color-manage-actions {
                flex-direction: column;
                gap: 4px;
            }
            
            /* ç©ºçŠ¶æ€ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .empty-state {
                padding: 40px 20px !important;
            }
            
            .empty-icon {
                font-size: 48px;
            }
            
            .empty-text {
                font-size: 14px;
            }
        }
        
        @media (max-width: 360px) {
            .settings-section h2 {
                font-size: 16px !important;
            }
            
            .table-grid-three-columns {
                grid-template-columns: repeat(3, 1fr) !important;
            }
            
            .table-mini .table-name {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <nav class="sidebar">
            <a href="index.html" class="logo">
                <h2 id="shopNameDisplay">æ‹¼è±†è®¡æ—¶å™¨</h2>
                <span class="version">V1.0</span>
            </a>
            
            <div class="nav-menu">
                <a href="timer.html" class="nav-item">
                    <span class="icon">â±ï¸</span>
                    <span>æ”¶è´¹ç®¡ç†</span>
                </a>
                <a href="inventory.html" class="nav-item">
                    <span class="icon">ğŸ“¦</span>
                    <span>åº“å­˜ç®¡ç†</span>
                </a>
                <a href="revenue-expense.html" class="nav-item">
                    <span class="icon">ğŸ’°</span>
                    <span>æ”¶æ”¯ç®¡ç†</span>
                </a>
                <a href="settings.html" class="nav-item active">
                    <span class="icon">âš™ï¸</span>
                    <span>ç³»ç»Ÿè®¾ç½®</span>
                </a>
            </div>
        </nav>
        
        <main class="main-content">
            <div class="settings-page">
                <div class="page-header">
                    <h1>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h1>
                </div>
                
                <div class="settings-section">
                    <h2>ğŸª åº—é“ºä¿¡æ¯</h2>
                    <div class="form-group">
                        <label>åº—é“ºåç§°</label>
                        <input type="text" id="shopName" class="form-control" placeholder="è¯·è¾“å…¥åº—é“ºåç§°" onchange="autoSaveSetting('shopName', this.value)">
                    </div>
                    <div class="form-group">
                        <label>è”ç³»ç”µè¯</label>
                        <input type="tel" id="shopPhone" class="form-control" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" onchange="autoSaveSetting('shopPhone', this.value)">
                    </div>
                    <div class="form-group">
                        <label>åº—é“ºåœ°å€</label>
                        <textarea id="shopAddress" class="form-control" placeholder="è¯·è¾“å…¥åº—é“ºåœ°å€" onchange="autoSaveSetting('shopAddress', this.value)"></textarea>
                    </div>
                    <div class="form-group">
                        <label>åº—é“ºå›¾æ ‡</label>
                        <div class="icon-upload-area">
                            <div class="icon-preview">
                                <span class="placeholder" id="iconPlaceholder">ğŸ¨</span>
                                <img id="iconPreview" style="display: none;">
                            </div>
                            <div class="icon-actions">
                                <input type="file" id="iconFile" accept="image/*" style="display: none;" onchange="handleIconUpload(event)">
                                <button onclick="document.getElementById('iconFile').click()" class="btn btn-primary">ä¸Šä¼ å›¾æ ‡</button>
                                <input type="text" id="iconUrl" class="form-control" placeholder="æˆ–è¾“å…¥å›¾ç‰‡URL" onchange="loadIconFromUrl()">
                                <button onclick="clearIcon()" class="btn btn-danger">åˆ é™¤å›¾æ ‡</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h2>ğŸ’µ è®¡è´¹è®¾ç½®</h2>
                    <div class="form-group">
                        <label>æŒ‰å°æ—¶æ”¶è´¹ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="pricePerHour" class="form-control" step="0.01" min="0" onchange="autoSaveSetting('pricePerHour', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label>åŒ…æ—¥ä»·æ ¼ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="pricePerDay" class="form-control" step="0.01" min="0" onchange="autoSaveSetting('pricePerDay', parseFloat(this.value))">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h2>ğŸ·ï¸ æŠ˜æ‰£è®¾ç½®</h2>
                    <div class="form-group">
                        <label>ä¼šå‘˜æŠ˜æ‰£ï¼ˆ%ï¼‰</label>
                        <input type="number" id="memberDiscount" class="form-control" step="1" min="0" max="100" onchange="autoSaveSetting('memberDiscount', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label>VIPæŠ˜æ‰£ï¼ˆ%ï¼‰</label>
                        <input type="number" id="vipDiscount" class="form-control" step="1" min="0" max="100" onchange="autoSaveSetting('vipDiscount', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label>å­¦ç”ŸæŠ˜æ‰£ï¼ˆ%ï¼‰</label>
                        <input type="number" id="studentDiscount" class="form-control" step="1" min="0" max="100" onchange="autoSaveSetting('studentDiscount', parseFloat(this.value))">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h2>ğŸ“± å¹³å°è´¹ç‡è®¾ç½®</h2>
                    <div class="form-group">
                        <label>ç¾å›¢è´¹ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="meituanFeeRate" class="form-control" step="0.1" min="0" max="100" onchange="autoSavePlatformFee('meituan', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label>æŠ–éŸ³è´¹ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="douyinFeeRate" class="form-control" step="0.1" min="0" max="100" onchange="autoSavePlatformFee('douyin', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label>å¤§ä¼—ç‚¹è¯„è´¹ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="dianpingFeeRate" class="form-control" step="0.1" min="0" max="100" onchange="autoSavePlatformFee('dianping', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label>å°çº¢ä¹¦è´¹ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="xiaohongshuFeeRate" class="form-control" step="0.1" min="0" max="100" onchange="autoSavePlatformFee('xiaohongshu', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label>å…¶ä»–å¹³å°è´¹ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="customFeeRate" class="form-control" step="0.1" min="0" max="100" onchange="autoSavePlatformFee('custom', parseFloat(this.value))">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h2>ğŸ“‹ æ¡Œä½ç®¡ç†</h2>
                    <div class="form-group">
                        <label>å½“å‰æ¡Œä½æ•°ï¼š<span id="currentTableCount">0</span></label>
                        <div class="table-actions-row">
                            <button onclick="addOneTable()" class="btn btn-success">â• æ·»åŠ 1ä¸ªæ¡Œä½</button>
                            <button onclick="deleteFreeTables()" class="btn btn-danger">â– åˆ é™¤ç©ºé—²æ¡Œä½</button>
                            <button onclick="regenerateTables()" class="btn btn-warning">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                        </div>
                    </div>
                    <div class="table-list-mini">
                        <div id="tableGrid" class="table-grid-three-columns"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h2>ğŸ“¦ åº“å­˜è®¾ç½®</h2>
                    <div class="form-group">
                        <label>ä½åº“å­˜é˜ˆå€¼ï¼ˆå…‹ï¼‰</label>
                        <input type="number" id="lowStockThreshold" class="form-control" step="10" min="0" onchange="autoSaveInventoryConfig('lowStockThreshold', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label>å¿«æ·å¢åŠ é‡ï¼ˆå…‹ï¼‰</label>
                        <input type="number" id="inventoryQuickIncreaseAmount" class="form-control" step="10" min="1" onchange="autoSaveInventoryConfig('quickIncreaseAmount', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label>å¿«æ·å‡å°‘é‡ï¼ˆå…‹ï¼‰</label>
                        <input type="number" id="inventoryQuickDecreaseAmount" class="form-control" step="5" min="1" onchange="autoSaveInventoryConfig('quickDecreaseAmount', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label>ç»Ÿè®¡å¤©æ•°</label>
                        <input type="number" id="inventoryStatsDays" class="form-control" min="1" max="30" onchange="autoSaveInventoryConfig('statsDays', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label>TOP N æ¶ˆè€—æ’è¡Œ</label>
                        <input type="number" id="inventoryTopNConsumption" class="form-control" min="1" max="50" onchange="autoSaveInventoryConfig('topNConsumption', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label>è‡ªåŠ¨å¤‡ä»½</label>
                        <select id="inventoryAutoBackup" class="form-control" onchange="autoSaveInventoryConfig('autoBackup', this.value === 'true')">
                            <option value="true">å¼€å¯</option>
                            <option value="false">å…³é—­</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å¤‡ä»½é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
                        <input type="number" id="inventoryBackupInterval" class="form-control" min="1" max="168" onchange="autoSaveInventoryConfig('backupInterval', parseInt(this.value))">
                    </div>
                </div>
                
                <!-- V3.2æ–°å¢ï¼šå…¶ä»–æ”¶è´¹é¡¹ç›®é…ç½® -->
                <div class="settings-section">
                    <h2>ğŸ’³ å…¶ä»–æ”¶è´¹é¡¹ç›®é…ç½®</h2>
                    <div class="form-group">
                        <label>æ”¶è´¹é¡¹ç›®åˆ—è¡¨</label>
                        <div id="otherChargeItemsList" class="other-charge-items-list">
                            <!-- åŠ¨æ€åŠ è½½æ”¶è´¹é¡¹ç›® -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ·»åŠ æ”¶è´¹é¡¹ç›®</label>
                        <div style="display: grid; grid-template-columns: 1fr 100px 80px auto; gap: 10px;">
                            <input type="text" id="newChargeItemName" class="form-control" placeholder="é¡¹ç›®åç§°">
                            <input type="number" id="newChargeItemPrice" class="form-control" placeholder="ä»·æ ¼" step="0.01" min="0">
                            <input type="text" id="newChargeItemUnit" class="form-control" placeholder="å•ä½">
                            <button onclick="addOtherChargeItem()" class="btn btn-primary">æ·»åŠ </button>
                        </div>
                    </div>
                </div>
                
                <!-- V3.1æ–°å¢ï¼šç”¨æˆ·ç®¡ç† -->
                <div class="settings-section">
                    <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                    <div class="form-group">
                        <label>ç”¨æˆ·åˆ—è¡¨</label>
                        <div id="userList" class="user-list">
                            <!-- åŠ¨æ€åŠ è½½ç”¨æˆ· -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ·»åŠ ç”¨æˆ·</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 10px;">
                            <input type="text" id="newUsername" class="form-control" placeholder="ç”¨æˆ·å">
                            <input type="text" id="newPassword" class="form-control" placeholder="å¯†ç ">
                            <input type="text" id="newUserName" class="form-control" placeholder="å§“å">
                            <select id="newUserRole" class="form-control">
                                <option value="user">æ™®é€šç”¨æˆ·</option>
                                <option value="admin">ç®¡ç†å‘˜</option>
                            </select>
                            <button onclick="addUser()" class="btn btn-primary">æ·»åŠ </button>
                        </div>
                    </div>
                </div>
                
                <!-- V3.1æ–°å¢ï¼šè´¹ç”¨åˆ†æ‘Š -->
                <div class="settings-section">
                    <h2>ğŸ’° è´¹ç”¨åˆ†æ‘Šè®¾ç½®</h2>
                    <div class="form-group">
                        <label>å¯ç”¨è´¹ç”¨åˆ†æ‘Š</label>
                        <select id="costSharingEnabled" class="form-control" onchange="toggleCostSharing()">
                            <option value="false">ä¸å¯ç”¨</option>
                            <option value="true">å¯ç”¨</option>
                        </select>
                    </div>
                    <div id="costSharingConfig" style="display: none;">
                        <div class="form-group">
                            <label>åˆ†æ‘ŠèŒƒå›´</label>
                            <select id="sharingScope" class="form-control">
                                <option value="revenue">æŒ‰æ”¶å…¥åˆ†æ‘Š</option>
                                <option value="profit">æŒ‰åˆ©æ¶¦åˆ†æ‘Šï¼ˆæ”¶å…¥-æ”¯å‡ºï¼‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>åˆä¼™äººåˆ—è¡¨</label>
                            <div id="partnerList" class="partner-list">
                                <!-- åŠ¨æ€åŠ è½½åˆä¼™äºº -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>æ·»åŠ åˆä¼™äºº</label>
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px;">
                                <input type="text" id="newPartnerName" class="form-control" placeholder="åˆä¼™äººåç§°">
                                <input type="number" id="newPartnerRatio" class="form-control" placeholder="æ¯”ä¾‹%" step="1" min="0" max="100">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="newPartnerEnabled" checked>
                                    å¯ç”¨
                                </label>
                                <button onclick="addPartner()" class="btn btn-primary">æ·»åŠ </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h2>ğŸ’¾ æ•°æ®ç®¡ç†</h2>
                    <div class="form-group">
                        <label>å¯¼å‡ºé…ç½®</label>
                        <button onclick="exportConfig()" class="btn btn-secondary">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
                    </div>
                    <div class="form-group">
                        <label>å¯¼å…¥é…ç½®</label>
                        <input type="file" id="configFile" accept=".json" style="display: none;" onchange="importConfig(event)">
                        <button onclick="document.getElementById('configFile').click()" class="btn btn-secondary">ğŸ“¥ å¯¼å…¥é…ç½®</button>
                    </div>
                    <div class="form-group">
                        <label>å±é™©æ“ä½œ</label>
                        <button onclick="clearAllData()" class="btn btn-danger">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button onclick="saveSettings()" class="btn btn-primary btn-large">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- è‰²å·ç¼–è¾‘å¼¹çª— -->
    <div id="colorModal" class="modal">
        <div class="modal-content enhanced" style="max-width: 600px;">
            <h2 id="colorModalTitle">â• æ·»åŠ è‰²å·</h2>
            <div class="form-group">
                <label>è‰²å·</label>
                <input type="text" id="colorCode" class="form-control enhanced" placeholder="ä¾‹å¦‚ï¼šA1" maxlength="20">
            </div>
            <div class="form-group">
                <label>åˆ†ç»„</label>
                <select id="colorGroup" class="form-control">
                    <option value="A">Aç»„ - é»„è‰²ç³»åˆ—</option>
                    <option value="B">Bç»„ - ç»¿è‰²ç³»åˆ—</option>
                    <option value="C">Cç»„ - è“è‰²ç³»åˆ—</option>
                    <option value="D">Dç»„ - ç´«è‰²ç³»åˆ—</option>
                    <option value="E">Eç»„ - ç²‰è‰²ç³»åˆ—</option>
                    <option value="F">Fç»„ - çº¢è‰²ç³»åˆ—</option>
                    <option value="G">Gç»„ - æ£•è‰²ç³»åˆ—</option>
                    <option value="H">Hç»„ - é»‘è‰²ç³»åˆ—</option>
                    <option value="M">Mç»„ - ä½é¥±å’Œè‰²</option>
                </select>
            </div>
            <div class="modal-actions">
                <button onclick="closeColorModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="saveColor()" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <script src="bead-data.js"></script>
    <script src="common.js"></script>
    <script>
        let editingColorCode = null;
        let currentColorImage = null;
        
        // åˆå§‹åŒ–é¡µé¢
        function initSettingsPage() {
            loadConfig();
            updateShopNameDisplay();
            loadSettings();
            loadTableList();
            loadColorList();
            loadColorGroupList();
            updateIconDisplay();
            // V3.1æ–°å¢ï¼šåŠ è½½ç”¨æˆ·ç®¡ç†å’Œè´¹ç”¨åˆ†æ‘Š
            loadUserList();
            loadPartnerList();
            toggleCostSharing();
            // V3.2æ–°å¢ï¼šåŠ è½½å…¶ä»–æ”¶è´¹é¡¹ç›®
            loadOtherChargeItemsList();
            // åŠ è½½åº“å­˜é…ç½®
            loadInventorySettings();
        }
        
        // åŠ è½½åº“å­˜é…ç½®
        function loadInventorySettings() {
            if (!config.inventoryConfig) {
                config.inventoryConfig = {
                    quickIncreaseAmount: 100,
                    quickDecreaseAmount: 15,
                    statsDays: 7,
                    topNConsumption: 10,
                    autoBackup: true,
                    backupInterval: 24,
                    lowStockThreshold: 50
                };
            }

            document.getElementById('lowStockThreshold').value = config.inventoryConfig.lowStockThreshold || 50;
            document.getElementById('inventoryQuickIncreaseAmount').value = config.inventoryConfig.quickIncreaseAmount || 100;
            document.getElementById('inventoryQuickDecreaseAmount').value = config.inventoryConfig.quickDecreaseAmount || 15;
            document.getElementById('inventoryStatsDays').value = config.inventoryConfig.statsDays || 7;
            document.getElementById('inventoryTopNConsumption').value = config.inventoryConfig.topNConsumption || 10;
            document.getElementById('inventoryAutoBackup').value = config.inventoryConfig.autoBackup ? 'true' : 'false';
            document.getElementById('inventoryBackupInterval').value = config.inventoryConfig.backupInterval || 24;
        }
        
        // è‡ªåŠ¨ä¿å­˜åº“å­˜é…ç½®
        function autoSaveInventoryConfig(key, value) {
            if (!config.inventoryConfig) {
                config.inventoryConfig = {};
            }
            config.inventoryConfig[key] = value;
            saveConfig();
            showNotification('è®¾ç½®å·²ä¿å­˜');
        }
        
        // åŠ è½½è®¾ç½®
        function loadSettings() {
            document.getElementById('shopName').value = config.shopName || '';
            document.getElementById('shopPhone').value = config.shopPhone || '';
            document.getElementById('shopAddress').value = config.shopAddress || '';
            document.getElementById('pricePerHour').value = config.pricePerHour || 15;
            document.getElementById('pricePerDay').value = config.pricePerDay || 50;
            document.getElementById('memberDiscount').value = config.memberDiscount || 10;
            document.getElementById('vipDiscount').value = config.vipDiscount || 20;
            document.getElementById('studentDiscount').value = config.studentDiscount || 15;
            // åŠ è½½åº“å­˜é…ç½®ï¼ˆV3.2æ–°å¢ï¼‰
            if (config.inventoryConfig) {
                document.getElementById('lowStockThreshold').value = config.inventoryConfig.lowStockThreshold || 250;
                document.getElementById('inventoryQuickIncreaseAmount').value = config.inventoryConfig.quickIncreaseAmount || 100;
                document.getElementById('inventoryQuickDecreaseAmount').value = config.inventoryConfig.quickDecreaseAmount || 15;
                document.getElementById('inventoryStatsDays').value = config.inventoryConfig.statsDays || 7;
                document.getElementById('inventoryTopNConsumption').value = config.inventoryConfig.topNConsumption || 10;
                document.getElementById('inventoryAutoBackup').value = config.inventoryConfig.autoBackup ? 'true' : 'false';
                document.getElementById('inventoryBackupInterval').value = config.inventoryConfig.backupInterval || 24;
            } else {
                document.getElementById('lowStockThreshold').value = 250;
                document.getElementById('inventoryQuickIncreaseAmount').value = 100;
                document.getElementById('inventoryQuickDecreaseAmount').value = 15;
                document.getElementById('inventoryStatsDays').value = 7;
                document.getElementById('inventoryTopNConsumption').value = 10;
                document.getElementById('inventoryAutoBackup').value = 'true';
                document.getElementById('inventoryBackupInterval').value = 24;
            }
            
            // åŠ è½½å¹³å°è´¹ç‡ï¼ˆV3.0æ–°å¢ï¼‰
            if (config.platformFees) {
                document.getElementById('meituanFeeRate').value = config.platformFees.meituan?.feeRate || 15;
                document.getElementById('douyinFeeRate').value = config.platformFees.douyin?.feeRate || 18;
                document.getElementById('dianpingFeeRate').value = config.platformFees.dianping?.feeRate || 12;
                document.getElementById('xiaohongshuFeeRate').value = config.platformFees.xiaohongshu?.feeRate || 10;
                document.getElementById('customFeeRate').value = config.platformFees.custom?.feeRate || 0;
            } else {
                document.getElementById('meituanFeeRate').value = 15;
                document.getElementById('douyinFeeRate').value = 18;
                document.getElementById('dianpingFeeRate').value = 12;
                document.getElementById('xiaohongshuFeeRate').value = 10;
                document.getElementById('customFeeRate').value = 0;
            }
        }
        
        // è‡ªåŠ¨ä¿å­˜è®¾ç½®
        function autoSaveSetting(key, value) {
            config[key] = value;
            localStorage.setItem('perlerTimerConfig', JSON.stringify(config));
            updateShopNameDisplay();
            showNotification('è®¾ç½®å·²è‡ªåŠ¨ä¿å­˜');
        }
        
        // è‡ªåŠ¨ä¿å­˜å¹³å°è´¹ç‡
        function autoSavePlatformFee(platform, value) {
            if (!config.platformFees) {
                config.platformFees = {
                    meituan: { name: 'ç¾å›¢', feeRate: 15, enabled: true },
                    douyin: { name: 'æŠ–éŸ³', feeRate: 18, enabled: true },
                    dianping: { name: 'å¤§ä¼—ç‚¹è¯„', feeRate: 12, enabled: true },
                    xiaohongshu: { name: 'å°çº¢ä¹¦', feeRate: 10, enabled: true },
                    custom: { name: 'å…¶ä»–å¹³å°', feeRate: 0, enabled: false }
                };
            }
            config.platformFees[platform].feeRate = value;
            localStorage.setItem('perlerTimerConfig', JSON.stringify(config));
            showNotification('å¹³å°è´¹ç‡å·²è‡ªåŠ¨ä¿å­˜');
        }
        
        // è‡ªåŠ¨ä¿å­˜åº“å­˜é…ç½®
        function autoSaveInventoryConfig(key, value) {
            if (!config.inventoryConfig) {
                config.inventoryConfig = {
                    quickIncreaseAmount: 100,
                    quickDecreaseAmount: 15,
                    statsDays: 7,
                    topNConsumption: 10,
                    autoBackup: true,
                    backupInterval: 24,
                    lowStockThreshold: 250
                };
            }
            config.inventoryConfig[key] = value;
            localStorage.setItem('perlerTimerConfig', JSON.stringify(config));
            showNotification('åº“å­˜é…ç½®å·²è‡ªåŠ¨ä¿å­˜');
        }
        
        // åŠ è½½æ¡Œä½åˆ—è¡¨
        function loadTableList() {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const container = document.getElementById('tableGrid');
            
            document.getElementById('currentTableCount').textContent = tables.length;
            
            container.innerHTML = tables.map(table => `
                <div class="table-mini ${table.status}">
                    <div class="table-name">${table.name}</div>
                    <div class="table-status">${table.status === 'in-use' ? 'ä½¿ç”¨ä¸­' : 'ç©ºé—²'}</div>
                </div>
            `).join('');
        }
        
        // æ·»åŠ 1ä¸ªæ¡Œä½
        function addOneTable() {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const newTableId = `table_${Date.now()}`;
            const newTableName = `${tables.length + 1}å·æ¡Œ`;
            
            tables.push({
                id: newTableId,
                name: newTableName,
                status: 'free',
                startTime: null,
                pauseTime: null,
                paused: false,
                chargeType: null,
                customerType: null,
                customerPhone: null,
                note: null
            });
            
            localStorage.setItem('perlerTimerTables', JSON.stringify(tables));
            loadTableList();
            showNotification('æ¡Œä½å·²æ·»åŠ ');
        }
        
        // åˆ é™¤ç©ºé—²æ¡Œä½
        function deleteFreeTables() {
            const tables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
            const freeTables = tables.filter(t => t.status === 'free');
            
            if (freeTables.length === 0) {
                alert('æ²¡æœ‰ç©ºé—²çš„æ¡Œä½å¯ä»¥åˆ é™¤ï¼');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${freeTables.length} ä¸ªç©ºé—²æ¡Œä½å—ï¼Ÿ`)) {
                const activeTables = tables.filter(t => t.status === 'in-use');
                localStorage.setItem('perlerTimerTables', JSON.stringify(activeTables));
                loadTableList();
                showNotification('ç©ºé—²æ¡Œä½å·²åˆ é™¤');
            }
        }
        
        // é‡æ–°ç”Ÿæˆæ¡Œä½
        function regenerateTables() {
            if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆæ¡Œä½å—ï¼Ÿæ‰€æœ‰æ¡Œä½å°†è¢«é‡ç½®ï¼')) {
                return;
            }
            
            const count = parseInt(prompt('è¯·è¾“å…¥æ¡Œä½æ•°ï¼š', '30')) || 30;
            
            const tables = [];
            for (let i = 1; i <= count; i++) {
                tables.push({
                    id: `table_${i}`,
                    name: `${i}å·æ¡Œ`,
                    status: 'free',
                    startTime: null,
                    pauseTime: null,
                    paused: false,
                    chargeType: null,
                    customerType: null,
                    customerPhone: null,
                    note: null
                });
            }
            
            localStorage.setItem('perlerTimerTables', JSON.stringify(tables));
            loadTableList();
            showNotification('æ¡Œä½å·²é‡æ–°ç”Ÿæˆ');
        }
        
        // å¤„ç†è‰²å·å›¾ç‰‡ä¸Šä¼ 
        function handleColorImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 200 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡200KBï¼');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentColorImage = e.target.result;
                updateColorImageDisplay();
            };
            reader.readAsDataURL(file);
        }
        
        // ä»URLåŠ è½½è‰²å·å›¾ç‰‡
        function loadColorImageFromUrl() {
            const url = document.getElementById('colorImageUrl').value.trim();
            if (url) {
                currentColorImage = url;
                updateColorImageDisplay();
            }
        }
        
        // æ›´æ–°è‰²å·å›¾ç‰‡æ˜¾ç¤º
        function updateColorImageDisplay() {
            const placeholder = document.getElementById('colorImagePlaceholder');
            const display = document.getElementById('colorImageDisplay');
            
            if (currentColorImage) {
                placeholder.style.display = 'none';
                display.style.display = 'block';
                display.src = currentColorImage;
            } else {
                placeholder.style.display = 'block';
                display.style.display = 'none';
            }
        }
        
        // æ¸…é™¤è‰²å·å›¾ç‰‡
        function clearColorImage() {
            currentColorImage = null;
            document.getElementById('colorImageUrl').value = '';
            updateColorImageDisplay();
        }
        
        // å¤„ç†å›¾æ ‡ä¸Šä¼ 
        function handleIconUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 100 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡100KBï¼');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                config.shopIcon = e.target.result;
                updateIconDisplay();
            };
            reader.readAsDataURL(file);
        }
        
        // ä»URLåŠ è½½å›¾æ ‡
        function loadIconFromUrl() {
            const url = document.getElementById('iconUrl').value.trim();
            if (url) {
                config.shopIcon = url;
                updateIconDisplay();
            }
        }
        
        // æ›´æ–°å›¾æ ‡æ˜¾ç¤º
        function updateIconDisplay() {
            const placeholder = document.getElementById('iconPlaceholder');
            const preview = document.getElementById('iconPreview');
            
            if (config.shopIcon) {
                placeholder.style.display = 'none';
                preview.style.display = 'block';
                preview.src = config.shopIcon;
            } else {
                placeholder.style.display = 'block';
                preview.style.display = 'none';
            }
        }
        
        // æ¸…é™¤å›¾æ ‡
        function clearIcon() {
            config.shopIcon = '';
            document.getElementById('iconUrl').value = '';
            updateIconDisplay();
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            config.shopName = document.getElementById('shopName').value;
            config.shopPhone = document.getElementById('shopPhone').value;
            config.shopAddress = document.getElementById('shopAddress').value;
            config.pricePerHour = parseFloat(document.getElementById('pricePerHour').value) || 15;
            config.pricePerDay = parseFloat(document.getElementById('pricePerDay').value) || 50;
            config.memberDiscount = parseFloat(document.getElementById('memberDiscount').value) || 10;
            config.vipDiscount = parseFloat(document.getElementById('vipDiscount').value) || 20;
            config.studentDiscount = parseFloat(document.getElementById('studentDiscount').value) || 15;
            
            // ä¿å­˜å¹³å°è´¹ç‡ï¼ˆV3.0æ–°å¢ï¼‰
            config.platformFees = {
                meituan: { name: 'ç¾å›¢', feeRate: parseFloat(document.getElementById('meituanFeeRate').value) || 15, enabled: true },
                douyin: { name: 'æŠ–éŸ³', feeRate: parseFloat(document.getElementById('douyinFeeRate').value) || 18, enabled: true },
                dianping: { name: 'å¤§ä¼—ç‚¹è¯„', feeRate: parseFloat(document.getElementById('dianpingFeeRate').value) || 12, enabled: true },
                xiaohongshu: { name: 'å°çº¢ä¹¦', feeRate: parseFloat(document.getElementById('xiaohongshuFeeRate').value) || 10, enabled: true },
                custom: { name: 'å…¶ä»–å¹³å°', feeRate: parseFloat(document.getElementById('customFeeRate').value) || 0, enabled: false }
            };
            
            // V3.1æ–°å¢ï¼šä¿å­˜ç”¨æˆ·ç®¡ç†
            config.users = loadUsersFromUI();
            
            // V3.1æ–°å¢ï¼šä¿å­˜è´¹ç”¨åˆ†æ‘Š
            config.costSharing = {
                enabled: document.getElementById('costSharingEnabled').value === 'true',
                sharingScope: document.getElementById('sharingScope').value || 'revenue',
                partners: loadPartnersFromUI()
            };
            
            localStorage.setItem('perlerTimerConfig', JSON.stringify(config));
            
            updateShopNameDisplay();
            showNotification('è®¾ç½®å·²ä¿å­˜');
        }
        
        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            const exportData = {
                ...config,
                tables: JSON.parse(localStorage.getItem('perlerTimerTables') || '[]'),
                version: 'V2.2',
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æ‹¼è±†è®¡æ—¶å™¨é…ç½®_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('é…ç½®å·²å¯¼å‡º');
        }
        
        // å¯¼å…¥é…ç½®
        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (importData.version && importData.shopName !== undefined) {
                        // ä¿ç•™åŸæœ‰æ•°æ®ç»“æ„
                        const originalTables = JSON.parse(localStorage.getItem('perlerTimerTables') || '[]');
                        const originalOrders = JSON.parse(localStorage.getItem('perlerTimerOrders') || '[]');
                        const originalExpenses = JSON.parse(localStorage.getItem('perlerTimerExpenses') || '[]');
                        const originalBeads = JSON.parse(localStorage.getItem('perlerTimerBeads') || '[]');
                        const originalLogs = JSON.parse(localStorage.getItem('perlerTimerInventoryLogs') || '[]');
                        
                        // å¯¼å…¥é…ç½®
                        config = {...config, ...importData};
                        
                        // å¦‚æœæœ‰æ¡Œä½æ•°æ®ï¼Œå¯é€‰æ‹©æ˜¯å¦å¯¼å…¥
                        if (importData.tables && confirm('æ£€æµ‹åˆ°æ¡Œä½æ•°æ®ï¼Œæ˜¯å¦å¯¼å…¥ï¼Ÿ\n\næ³¨æ„ï¼šè¿™å°†è¦†ç›–ç°æœ‰æ¡Œä½æ•°æ®ï¼')) {
                            localStorage.setItem('perlerTimerTables', JSON.stringify(importData.tables));
                        }
                        
                        localStorage.setItem('perlerTimerConfig', JSON.stringify(config));
                        
                        loadSettings();
                        loadTableList();
                        updateIconDisplay();
                        updateShopNameDisplay();
                        
                        showNotification('é…ç½®å·²å¯¼å…¥');
                    } else {
                        alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
                    }
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // åŠ è½½è‰²å·åˆ—è¡¨
        function loadColorList() {
            const filter = document.getElementById('colorGroupFilter').value;
            const sortBy = document.getElementById('colorSortBy').value;
            const container = document.getElementById('colorList');
            let beads = JSON.parse(localStorage.getItem('perlerTimerBeads')) || [];
            
            // å¦‚æœæ²¡æœ‰è‰²å·ï¼Œä»é»˜è®¤è‰²å¡åˆå§‹åŒ–
            if (beads.length === 0) {
                beads = [...mard221Colors].map(c => ({
                    code: c.code,
                    name: c.name,
                    color: c.color,
                    stock: 0,
                    stockGram: 0
                }));
                localStorage.setItem('perlerTimerBeads', JSON.stringify(beads));
            }
            
            // è·å–åˆ†ç»„åˆ—è¡¨
            const groups = JSON.parse(localStorage.getItem('perlerTimerColorGroups')) || [];
            const groupMap = {};
            groups.forEach(g => {
                groupMap[g.code] = g.name;
            });
            
            // æŒ‰åˆ†ç»„ç­›é€‰
            if (filter !== 'all') {
                beads = beads.filter(b => b.code.startsWith(filter));
            }
            
            const [sortField, sortOrder] = sortBy.split('-');
            
            beads.sort((beadA, beadB) => {
                let comparison = 0;
                if (sortField === 'code') {
                    const aLetter = beadA.code.charAt(0);
                    const bLetter = beadB.code.charAt(0);
                    const aNum = parseInt(beadA.code.slice(1)) || 0;
                    const bNum = parseInt(beadB.code.slice(1)) || 0;
                    
                    if (aLetter !== bLetter) {
                        comparison = aLetter.localeCompare(bLetter);
                    } else {
                        comparison = aNum - bNum;
                    }
                } else if (sortField === 'name') {
                    comparison = beadA.name.localeCompare(beadB.name);
                } else if (sortField === 'stock') {
                    comparison = (beadA.stockGram || 0) - (beadB.stockGram || 0);
                }
                return sortOrder === 'desc' ? -comparison : comparison;
            });
            
            document.getElementById('colorCount').textContent = beads.length;
            
            if (filter !== 'all') {
                container.innerHTML = beads.map(bead => `
                    <div class="color-mini-card">
                        <div class="color-header">
                            <div class="color-preview" style="background: ${bead.color};"></div>
                            <div class="color-info">
                                <div class="color-code">${bead.code}</div>
                                <div class="color-name">${bead.name || ''}</div>
                            </div>
                        </div>
                        <div class="color-stock">
                            <div class="stock-main">
                                <span class="stock-value">${bead.stockGram || 0}</span>
                                <span class="stock-unit">å…‹</span>
                            </div>
                        </div>
                        <div class="color-actions">
                            <button onclick="deleteColor('${bead.code}')" class="btn-mini">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('');
            } else {
                // å…¨éƒ¨æ˜¾ç¤ºæŒ‰åˆ†ç»„
                let html = '';
                const allGroups = [...new Set(beads.map(b => b.code.charAt(0)))].sort();
                
                allGroups.forEach(groupKey => {
                    const groupColors = beads.filter(b => b.code.startsWith(groupKey));
                    if (groupColors.length > 0) {
                        const groupName = groupMap[groupKey] || `${groupKey}ç»„`;
                        html += `
                            <div class="color-group-section">
                                <h4 class="color-group-title">${groupName}</h4>
                                <div class="color-mini-grid">
                                    ${groupColors.map(bead => `
                                        <div class="color-mini-card">
                                            <div class="color-header">
                                                <div class="color-preview" style="background: ${bead.color};"></div>
                                                <div class="color-info">
                                                    <div class="color-code">${bead.code}</div>
                                                    <div class="color-name">${bead.name || ''}</div>
                                                </div>
                                            </div>
                                            <div class="color-stock">
                                                <div class="stock-main">
                                                    <span class="stock-value">${bead.stockGram || 0}</span>
                                                    <span class="stock-unit">å…‹</span>
                                                </div>
                                            </div>
                                            <div class="color-actions">
                                                <button onclick="deleteColor('${bead.code}')" class="btn-mini">ğŸ—‘ï¸</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                container.innerHTML = html;
            }
        }
        
        function openColorModal() {
            editingColorCode = null;
            document.getElementById('colorModalTitle').textContent = 'â• æ·»åŠ è‰²å·';
            document.getElementById('colorCode').value = '';
            document.getElementById('colorGroup').value = 'A';
            document.getElementById('colorModal').style.display = 'flex';
        }
        
        // å…³é—­è‰²å·å¼¹çª—
        function closeColorModal() {
            document.getElementById('colorModal').style.display = 'none';
            editingColorCode = null;
            currentColorImage = null;
        }
        
        // ä¿å­˜è‰²å·
        function saveColor() {
            const code = document.getElementById('colorCode').value.trim().toUpperCase();
            const group = document.getElementById('colorGroup').value;
            
            if (!code) {
                alert('è¯·å¡«å†™è‰²å·ï¼');
                return;
            }
            
            // æ£€æŸ¥è‰²å·æ ¼å¼
            if (!/^[A-J]\d*$/.test(code)) {
                alert('è‰²å·æ ¼å¼ä¸æ­£ç¡®ï¼åº”ä¸ºå­—æ¯A-Jå¼€å¤´ï¼Œå¦‚ï¼šA1');
                return;
            }
            
            const beads = JSON.parse(localStorage.getItem('perlerTimerBeads')) || [];
            
            // æ£€æŸ¥è‰²å·æ˜¯å¦é‡å¤
            if (editingColorCode && editingColorCode !== code) {
                if (beads.some(b => b.code === code)) {
                    alert('è¯¥è‰²å·å·²å­˜åœ¨ï¼');
                    return;
                }
            } else if (!editingColorCode) {
                if (beads.some(b => b.code === code)) {
                    alert('è¯¥è‰²å·å·²å­˜åœ¨ï¼');
                    return;
                }
            }
            
            if (editingColorCode) {
                const index = beads.findIndex(b => b.code === editingColorCode);
                if (index !== -1) {
                    beads[index].code = code;
                }
            } else {
                beads.push({
                    code: code,
                    color: '#FF0000',
                    stock: 0,
                    stockGram: 0
                });
            }
            
            localStorage.setItem('perlerTimerBeads', JSON.stringify(beads));
            loadColorList();
            closeColorModal();
            showNotification('è‰²å·å·²ä¿å­˜');
        }
        
        // åˆ é™¤è‰²å·
        function deleteColor(code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è‰²å· ${code} å—ï¼Ÿ`)) return;
            
            const beads = JSON.parse(localStorage.getItem('perlerTimerBeads')) || [];
            const filtered = beads.filter(b => b.code !== code);
            localStorage.setItem('perlerTimerBeads', JSON.stringify(filtered));
            loadColorList();
            showNotification('è‰²å·å·²åˆ é™¤');
        }
        
        // åŠ è½½è‰²å·åˆ†ç»„åˆ—è¡¨
        function loadColorGroupList() {
            const container = document.getElementById('colorGroupList');
            const groups = JSON.parse(localStorage.getItem('perlerTimerColorGroups')) || [];
            
            if (groups.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— åˆ†ç»„</div>';
                return;
            }
            
            container.innerHTML = `
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>åˆ†ç»„ä»£ç </th>
                            <th>åˆ†ç»„åç§°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${groups.map(group => `
                            <tr>
                                <td>${group.code}</td>
                                <td>${group.name}</td>
                                <td>
                                    <button onclick="deleteColorGroup('${group.code}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            updateColorGroupFilter();
        }
        
        // æ·»åŠ è‰²å·åˆ†ç»„
        function addColorGroup() {
            const code = document.getElementById('newGroupCode').value.trim().toUpperCase();
            const name = document.getElementById('newGroupName').value.trim();
            
            if (!code || !name) {
                alert('è¯·å¡«å†™åˆ†ç»„ä»£ç å’Œåç§°ï¼');
                return;
            }
            
            const groups = JSON.parse(localStorage.getItem('perlerTimerColorGroups')) || [];
            if (groups.find(g => g.code === code)) {
                alert('è¯¥åˆ†ç»„ä»£ç å·²å­˜åœ¨ï¼');
                return;
            }
            
            groups.push({ code, name });
            localStorage.setItem('perlerTimerColorGroups', JSON.stringify(groups));
            
            document.getElementById('newGroupCode').value = '';
            document.getElementById('newGroupName').value = '';
            
            loadColorGroupList();
            showNotification('åˆ†ç»„å·²æ·»åŠ ');
        }
        
        // åˆ é™¤è‰²å·åˆ†ç»„
        function deleteColorGroup(code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„ ${code} å—ï¼Ÿ`)) return;
            
            const groups = JSON.parse(localStorage.getItem('perlerTimerColorGroups')) || [];
            const filtered = groups.filter(g => g.code !== code);
            localStorage.setItem('perlerTimerColorGroups', JSON.stringify(filtered));
            loadColorGroupList();
            showNotification('åˆ†ç»„å·²åˆ é™¤');
        }
        
        // æ›´æ–°è‰²å·åˆ†ç»„ç­›é€‰é€‰é¡¹
        function updateColorGroupFilter() {
            const select = document.getElementById('colorGroupFilter');
            const groups = JSON.parse(localStorage.getItem('perlerTimerColorGroups')) || [];
            
            const currentValue = select.value;
            select.innerHTML = '<option value="all">å…¨éƒ¨</option>';
            
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.code;
                option.textContent = `${group.code}ç»„ - ${group.name}`;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // å¯¼å‡ºè‰²å·
        function exportColors() {
            const beads = JSON.parse(localStorage.getItem('perlerTimerBeads')) || [];
            const exportData = beads.map(b => ({
                code: b.code,
                name: b.name,
                color: b.color
            }));
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æ‹¼è±†è‰²å·_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('è‰²å·å·²å¯¼å‡º');
        }
        
        // é‡ç½®ä¸ºé»˜è®¤è‰²å·
        function resetToDefaultColors() {
            if (!confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤è‰²å·å—ï¼Ÿ\n\nè¿™å°†è¦†ç›–æ‰€æœ‰è‡ªå®šä¹‰è‰²å·ï¼')) return;
            if (!confirm('æœ€åç¡®è®¤ï¼šç¡®å®šè¦é‡ç½®å—ï¼Ÿ')) return;
            
            const defaultBeads = [...mard221Colors].map(c => ({
                code: c.code,
                name: c.name,
                color: c.color,
                stock: 0,
                stockGram: 0
            }));
            
            localStorage.setItem('perlerTimerBeads', JSON.stringify(defaultBeads));
            loadColorList();
            showNotification('è‰²å·å·²é‡ç½®ä¸ºé»˜è®¤');
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ä¸”æ— æ³•æ¢å¤ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                if (confirm('âš ï¸ æœ€åç¡®è®¤ï¼šç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                    localStorage.clear();
                    showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            }
        }
        
        // ==================== V3.2æ–°å¢ï¼šå…¶ä»–æ”¶è´¹é¡¹ç›®é…ç½®åŠŸèƒ½ ====================
        
        // åŠ è½½å…¶ä»–æ”¶è´¹é¡¹ç›®åˆ—è¡¨
        function loadOtherChargeItemsList() {
            const container = document.getElementById('otherChargeItemsList');
            console.log('=== è°ƒè¯•ï¼šåŠ è½½æ”¶è´¹é¡¹ç›®åˆ—è¡¨ ===');
            console.log('config.otherChargeItems:', config.otherChargeItems);
            console.log('config å¯¹è±¡:', config);
            const items = config.otherChargeItems || [];
            console.log('items æ•°ç»„:', items);
            console.log('items.length:', items.length);
            
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ”¶è´¹é¡¹ç›®</div>';
                return;
            }
            
            container.innerHTML = `
                <table class="charge-items-table">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®åç§°</th>
                            <th>ä»·æ ¼</th>
                            <th>å•ä½</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>Â¥${item.price.toFixed(2)}</td>
                                <td>${item.unit}</td>
                                <td>
                                    <span class="status-badge ${item.enabled ? 'enabled' : 'disabled'}">
                                        ${item.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                                    </span>
                                </td>
                                <td>
                                    <button onclick="toggleOtherChargeItem(${item.id})" class="btn btn-sm ${item.enabled ? 'btn-warning' : 'btn-success'}">
                                        ${item.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                    </button>
                                    <button onclick="editOtherChargeItem(${item.id})" class="btn btn-sm btn-primary">ç¼–è¾‘</button>
                                    <button onclick="deleteOtherChargeItem(${item.id})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // æ·»åŠ å…¶ä»–æ”¶è´¹é¡¹ç›®
        function addOtherChargeItem() {
            const name = document.getElementById('newChargeItemName').value.trim();
            const price = parseFloat(document.getElementById('newChargeItemPrice').value) || 0;
            const unit = document.getElementById('newChargeItemUnit').value.trim() || 'é¡¹';
            
            if (!name) {
                alert('è¯·è¾“å…¥é¡¹ç›®åç§°ï¼');
                return;
            }
            
            if (!config.otherChargeItems) {
                config.otherChargeItems = [];
            }
            
            const newId = Date.now();
            config.otherChargeItems.push({
                id: newId,
                name: name,
                price: price,
                unit: unit,
                enabled: true
            });
            
            localStorage.setItem('perlerTimerConfig', JSON.stringify(config));
            loadOtherChargeItemsList();
            
            document.getElementById('newChargeItemName').value = '';
            document.getElementById('newChargeItemPrice').value = '';
            document.getElementById('newChargeItemUnit').value = '';
            
            showNotification('æ”¶è´¹é¡¹ç›®å·²æ·»åŠ ');
        }
        
        // åˆ‡æ¢å…¶ä»–æ”¶è´¹é¡¹ç›®çŠ¶æ€
        function toggleOtherChargeItem(id) {
            const item = config.otherChargeItems.find(i => i.id === id);
            if (item) {
                item.enabled = !item.enabled;
                localStorage.setItem('perlerTimerConfig', JSON.stringify(config));
                loadOtherChargeItemsList();
                showNotification('æ”¶è´¹é¡¹ç›®çŠ¶æ€å·²æ›´æ–°');
            }
        }
        
        // ç¼–è¾‘å…¶ä»–æ”¶è´¹é¡¹ç›®
        function editOtherChargeItem(id) {
            const item = config.otherChargeItems.find(i => i.id === id);
            if (!item) return;
            
            const newName = prompt('è¯·è¾“å…¥æ–°çš„é¡¹ç›®åç§°ï¼š', item.name);
            if (newName === null) return;
            
            if (!newName.trim()) {
                alert('é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            
            const newPrice = prompt('è¯·è¾“å…¥æ–°çš„ä»·æ ¼ï¼š', item.price);
            if (newPrice === null) return;
            
            const newUnit = prompt('è¯·è¾“å…¥æ–°çš„å•ä½ï¼š', item.unit);
            if (newUnit === null) return;
            
            item.name = newName.trim();
            item.price = parseFloat(newPrice) || 0;
            item.unit = newUnit.trim() || 'é¡¹';
            
            localStorage.setItem('perlerTimerConfig', JSON.stringify(config));
            loadOtherChargeItemsList();
            showNotification('æ”¶è´¹é¡¹ç›®å·²æ›´æ–°');
        }
        
        // åˆ é™¤å…¶ä»–æ”¶è´¹é¡¹ç›®
        function deleteOtherChargeItem(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ”¶è´¹é¡¹ç›®å—ï¼Ÿ')) return;
            
            config.otherChargeItems = config.otherChargeItems.filter(i => i.id !== id);
            localStorage.setItem('perlerTimerConfig', JSON.stringify(config));
            loadOtherChargeItemsList();
            showNotification('æ”¶è´¹é¡¹ç›®å·²åˆ é™¤');
        }
        
        // ==================== V3.1æ–°å¢ï¼šç”¨æˆ·ç®¡ç†åŠŸèƒ½ ====================
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        function loadUserList() {
            const container = document.getElementById('userList');
            const users = config.users || [];
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— ç”¨æˆ·</div>';
                return;
            }
            
            container.innerHTML = `
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·å</th>
                            <th>å§“å</th>
                            <th>è§’è‰²</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.name}</td>
                                <td>
                                    <span class="role-badge ${user.role}">
                                        ${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}
                                    </span>
                                </td>
                                <td>
                                    ${user.username !== 'admin' ? `
                                        <button onclick="deleteUser('${user.username}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                                    ` : '-'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // æ·»åŠ ç”¨æˆ·
        function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const role = document.getElementById('newUserRole').value;
            
            if (!username || !password || !name) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
                return;
            }
            
            const users = config.users || [];
            if (users.find(u => u.username === username)) {
                alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼');
                return;
            }
            
            users.push({ username, password, name, role });
            config.users = users;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newUserName').value = '';
            
            loadUserList();
            showNotification('ç”¨æˆ·å·²æ·»åŠ ');
        }
        
        // åˆ é™¤ç”¨æˆ·
        function deleteUser(username) {
            if (username === 'admin') {
                alert('ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦å·ï¼');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ`)) return;
            
            const users = config.users || [];
            config.users = users.filter(u => u.username !== username);
            
            loadUserList();
            showNotification('ç”¨æˆ·å·²åˆ é™¤');
        }
        
        // ä»UIåŠ è½½ç”¨æˆ·æ•°æ®
        function loadUsersFromUI() {
            return config.users || [];
        }
        
        // ==================== V3.1æ–°å¢ï¼šè´¹ç”¨åˆ†æ‘ŠåŠŸèƒ½ ====================
        
        // åˆ‡æ¢è´¹ç”¨åˆ†æ‘Šæ˜¾ç¤º
        function toggleCostSharing() {
            const enabled = document.getElementById('costSharingEnabled').value === 'true';
            document.getElementById('costSharingConfig').style.display = enabled ? 'block' : 'none';
        }
        
        // åŠ è½½åˆä¼™äººåˆ—è¡¨
        function loadPartnerList() {
            const container = document.getElementById('partnerList');
            const costSharing = config.costSharing || {};
            const partners = costSharing.partners || [];
            
            if (partners.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— åˆä¼™äºº</div>';
                return;
            }
            
            container.innerHTML = `
                <table class="partner-table">
                    <thead>
                        <tr>
                            <th>åç§°</th>
                            <th>æ¯”ä¾‹</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${partners.map(partner => `
                            <tr>
                                <td>${partner.name}</td>
                                <td>${partner.shareRatio}%</td>
                                <td>
                                    <span class="status-badge ${partner.enabled ? 'enabled' : 'disabled'}">
                                        ${partner.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                                    </span>
                                </td>
                                <td>
                                    <button onclick="deletePartner(${partner.id})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // æ·»åŠ åˆä¼™äºº
        function addPartner() {
            const name = document.getElementById('newPartnerName').value.trim();
            const ratio = parseFloat(document.getElementById('newPartnerRatio').value) || 0;
            const enabled = document.getElementById('newPartnerEnabled').checked;
            
            if (!name) {
                alert('è¯·è¾“å…¥åˆä¼™äººåç§°ï¼');
                return;
            }
            
            if (ratio <= 0 || ratio > 100) {
                alert('æ¯”ä¾‹å¿…é¡»åœ¨0-100ä¹‹é—´ï¼');
                return;
            }
            
            const costSharing = config.costSharing || { partners: [] };
            const partners = costSharing.partners || [];
            
            const newId = partners.length > 0 ? Math.max(...partners.map(p => p.id)) + 1 : 1;
            partners.push({ id: newId, name, shareRatio: ratio, enabled });
            
            config.costSharing = { ...costSharing, partners };
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('newPartnerName').value = '';
            document.getElementById('newPartnerRatio').value = '';
            document.getElementById('newPartnerEnabled').checked = true;
            
            loadPartnerList();
            showNotification('åˆä¼™äººå·²æ·»åŠ ');
        }
        
        // åˆ é™¤åˆä¼™äºº
        function deletePartner(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥åˆä¼™äººå—ï¼Ÿ')) return;
            
            const costSharing = config.costSharing || { partners: [] };
            const partners = costSharing.partners || [];
            config.costSharing = { ...costSharing, partners: partners.filter(p => p.id !== id) };
            
            loadPartnerList();
            showNotification('åˆä¼™äººå·²åˆ é™¤');
        }
        
        // ä»UIåŠ è½½åˆä¼™äººæ•°æ®
        function loadPartnersFromUI() {
            const costSharing = config.costSharing || {};
            return costSharing.partners || [];
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            initSettingsPage();
        });
    </script>
</body>
</html>
