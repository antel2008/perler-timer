<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº“å­˜ç®¡ç† - æ‹¼è±†è®¡æ—¶å™¨ Pro V1.0</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ‹¼è±†è®¡æ—¶å™¨">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        .inventory-page {
            padding: 30px;
        }
        
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .inventory-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card .label {
            font-size: 14px;
            color: #636e72;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #2d3436;
        }
        
        .inventory-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #dfe6e9;
            color: #636e72;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-btn:hover {
            transform: translateY(-2px);
        }
        
        .color-series-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .color-series-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .series-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dfe6e9;
        }
        
        .series-color {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #dfe6e9;
        }
        
        .series-name {
            font-size: 18px;
            font-weight: 600;
        }
        
        .bead-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }
        
        .bead-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .bead-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }
        
        .bead-code {
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 5px;
        }
        
        .bead-stock {
            font-size: 12px;
            color: #636e72;
        }
        
        .bead-stock.low {
            color: #e74c3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            font-size: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #636e72;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d3436;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .record-list {
            margin-top: 20px;
        }
        
        .record-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .record-info {
            flex: 1;
        }
        
        .record-bead {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .record-detail {
            font-size: 12px;
            color: #636e72;
        }
        
        .record-amount {
            font-size: 16px;
            font-weight: 600;
            margin-right: 15px;
        }
        
        .record-amount.in {
            color: #38ef7d;
        }
        
        .record-amount.out {
            color: #f45c43;
        }
        
        .stats-chart {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-label {
            width: 100px;
            font-size: 12px;
            color: #636e72;
        }
        
        .chart-bar-container {
            flex: 1;
            height: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            overflow: hidden;
            margin: 0 10px;
        }
        
        .chart-bar-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s;
        }
        
        .chart-value {
            width: 80px;
            text-align: right;
            font-weight: 600;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .bead-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        
        .bead-btn {
            flex: 1;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bead-btn-in {
            background: #38ef7d;
            color: white;
        }
        
        .bead-btn-out {
            background: #f45c43;
            color: white;
        }
        
        .bead-btn:hover {
            transform: scale(1.05);
        }
        
        .batch-in-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .batch-in-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .batch-in-item label {
            flex: 1;
            font-weight: 500;
        }
        
        .batch-in-item input {
            width: 100px;
            padding: 8px;
            border: 2px solid #dfe6e9;
            border-radius: 6px;
        }
        
        .batch-in-item input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .overview-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .overview-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .overview-card.out {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        
        .overview-card.net {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .overview-card .label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .overview-card .value {
            font-size: 28px;
            font-weight: 600;
        }
        
        .rank-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .rank-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .rank-number.top3 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .rank-info {
            flex: 1;
        }
        
        .rank-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .rank-value {
            font-size: 12px;
            color: #636e72;
        }
        
        .rank-amount {
            font-size: 18px;
            font-weight: 600;
            color: #f45c43;
        }
        
        .trend-line {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            height: 150px;
            padding: 10px 0;
            border-bottom: 2px solid #dfe6e9;
        }
        
        .trend-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .trend-bar {
            width: 30px;
            background: linear-gradient(180deg, #f45c43 0%, #eb3349 100%);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s;
            min-height: 2px;
        }
        
        .trend-label {
            font-size: 11px;
            color: #636e72;
        }
        
        .trend-value {
            font-size: 12px;
            font-weight: 600;
            color: #f45c43;
        }
    </style>
</head>
<body>
    <div class="app">
        <nav class="sidebar">
            <a href="index.html" class="logo">
                <h2 id="shopNameDisplay">ğŸ¨ æ‹¼è±†è®¡æ—¶å™¨</h2>
                <span class="version">V1.0</span>
            </a>
            
            <div class="nav-menu">
                <a href="timer.html" class="nav-item">
                    <span class="icon">â±ï¸</span>
                    <span>æ”¶è´¹ç®¡ç†</span>
                </a>
                <a href="inventory.html" class="nav-item active">
                    <span class="icon">ğŸ“¦</span>
                    <span>åº“å­˜ç®¡ç†</span>
                </a>
                <a href="revenue-expense.html" class="nav-item">
                    <span class="icon">ğŸ’°</span>
                    <span>æ”¶æ”¯ç®¡ç†</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <span class="icon">âš™ï¸</span>
                    <span>ç³»ç»Ÿè®¾ç½®</span>
                </a>
            </div>
        </nav>
        
        <main class="main-content">
            <div class="inventory-page">
                <div class="inventory-header">
                    <h1>ğŸ“¦ åº“å­˜ç®¡ç†</h1>
                    <div>
                        <button onclick="exportToExcel()" class="btn btn-primary">ğŸ“¥ å¯¼å‡ºExcel</button>
                        <button onclick="openBatchInModal()" class="btn btn-primary">ğŸ“¦ æ‰¹é‡å…¥åº“</button>
                        <button onclick="openInModal()" class="btn btn-success">â• å…¥åº“</button>
                        <button onclick="openOutModal()" class="btn btn-danger">â– å‡ºåº“</button>
                    </div>
                </div>
                
                <div class="inventory-stats">
                    <div class="stat-card">
                        <div class="label">æ€»åº“å­˜</div>
                        <div class="value" id="totalStock">0å…‹</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ä»Šæ—¥å…¥åº“</div>
                        <div class="value" id="todayIn">0å…‹</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ä»Šæ—¥å‡ºåº“</div>
                        <div class="value" id="todayOut">0å…‹</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ä½åº“å­˜è‰²å·</div>
                        <div class="value" id="lowStockCount">0</div>
                    </div>
                </div>
                
                <div class="inventory-tabs">
                    <button class="tab-btn active" onclick="switchTab('stock')">åº“å­˜æ¦‚è§ˆ</button>
                    <button class="tab-btn" onclick="switchTab('records')">å‡ºå…¥åº“è®°å½•</button>
                    <button class="tab-btn" onclick="switchTab('stats')">ç»Ÿè®¡åˆ†æ</button>
                </div>
                
                <div id="stockTab" class="tab-content">
                    <div class="filter-bar">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="æœç´¢è‰²å·..." oninput="filterBeads()">
                        </div>
                        <div class="filter-controls">
                            <select id="filterSeries" class="form-control" onchange="filterBeads()" style="width: 150px;">
                                <option value="all">å…¨éƒ¨è‰²ç³»</option>
                            </select>
                            <select id="filterStock" class="form-control" onchange="filterBeads()" style="width: 150px;">
                                <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="normal">æ­£å¸¸åº“å­˜</option>
                                <option value="low">ä½åº“å­˜</option>
                            </select>
                            <select id="sortOrder" class="form-control" onchange="filterBeads()" style="width: 150px;">
                                <option value="default">é»˜è®¤æ’åº</option>
                                <option value="asc">åº“å­˜å‡åº</option>
                                <option value="desc">åº“å­˜é™åº</option>
                            </select>
                        </div>
                    </div>
                    <div id="colorSeriesGrid" class="color-series-grid"></div>
                </div>
                
                <div id="recordsTab" class="tab-content" style="display: none;">
                    <div class="search-box">
                        <input type="text" id="recordSearchInput" placeholder="æœç´¢è®°å½•..." oninput="filterRecords()">
                    </div>
                    <div id="recordList" class="record-list"></div>
                </div>
                
                <div id="statsTab" class="tab-content" style="display: none;">
                    <div class="stats-chart">
                        <h3 id="statsDaysTitle">ğŸ“Š æ¶ˆè€—æ¦‚è§ˆï¼ˆæœ€è¿‘7å¤©ï¼‰</h3>
                        <div id="consumptionOverview"></div>
                    </div>
                    <div class="stats-chart">
                        <h3>ğŸ”¥ è‰²ç³»æ¶ˆè€—æ’è¡Œ</h3>
                        <div id="seriesConsumption"></div>
                    </div>
                    <div class="stats-chart">
                        <h3>ğŸ“ˆ è‰²å·æ¶ˆè€—TOP10</h3>
                        <div id="beadConsumption"></div>
                    </div>
                    <div class="stats-chart">
                        <h3>ğŸ’¾ å‰©ä½™åº“å­˜æ’è¡Œ</h3>
                        <div id="stockRanking"></div>
                    </div>
                    <div class="stats-chart">
                        <h3>âš ï¸ ä½åº“å­˜é¢„è­¦</h3>
                        <div id="lowStockWarning"></div>
                    </div>
                    <div class="stats-chart">
                        <h3>ğŸ“… æ¯æ—¥æ¶ˆè€—è¶‹åŠ¿</h3>
                        <div id="dailyTrend"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="inModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â• å…¥åº“</h2>
                <button class="close-btn" onclick="closeModal('inModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>é€‰æ‹©è‰²å·</label>
                <select id="inBeadSelect" class="form-control"></select>
            </div>
            <div class="form-group">
                <label>å…¥åº“æ•°é‡ï¼ˆå…‹ï¼‰</label>
                <input type="number" id="inAmount" class="form-control" min="1" placeholder="è¯·è¾“å…¥å…¥åº“æ•°é‡">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <input type="text" id="inRemark" class="form-control" placeholder="è¯·è¾“å…¥å¤‡æ³¨">
            </div>
            <button onclick="submitIn()" class="btn btn-success" style="width: 100%;">ç¡®è®¤å…¥åº“</button>
        </div>
    </div>
    
    <div id="outModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â– å‡ºåº“</h2>
                <button class="close-btn" onclick="closeModal('outModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>é€‰æ‹©è‰²å·</label>
                <select id="outBeadSelect" class="form-control"></select>
            </div>
            <div class="form-group">
                <label>å‡ºåº“æ•°é‡ï¼ˆå…‹ï¼‰</label>
                <input type="number" id="outAmount" class="form-control" min="1" placeholder="è¯·è¾“å…¥å‡ºåº“æ•°é‡">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <input type="text" id="outRemark" class="form-control" placeholder="è¯·è¾“å…¥å¤‡æ³¨">
            </div>
            <button onclick="submitOut()" class="btn btn-danger" style="width: 100%;">ç¡®è®¤å‡ºåº“</button>
        </div>
    </div>
    
    <div id="batchInModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ğŸ“¦ æ‰¹é‡å…¥åº“</h2>
                <button class="close-btn" onclick="closeModal('batchInModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>é€‰æ‹©è‰²ç³»</label>
                <select id="batchSeriesSelect" class="form-control" onchange="populateBatchBeads()">
                    <option value="all">å…¨éƒ¨è‰²ç³»</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ‰¹é‡è®¾ç½®æ•°é‡ï¼ˆå…‹ï¼‰</label>
                <input type="number" id="batchDefaultAmount" class="form-control" min="0" placeholder="é»˜è®¤æ•°é‡ï¼Œç•™ç©ºåˆ™ä¸è®¾ç½®" oninput="setBatchDefaultAmount()">
            </div>
            <div class="batch-in-list" id="batchBeadList"></div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <input type="text" id="batchRemark" class="form-control" placeholder="è¯·è¾“å…¥å¤‡æ³¨">
            </div>
            <button onclick="submitBatchIn()" class="btn btn-primary" style="width: 100%;">ç¡®è®¤æ‰¹é‡å…¥åº“</button>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        const colorSeriesData = {
            'A': { name: 'é»„è‰²ç³»åˆ—', color: '#FFD700', beads: ['A01', 'A02', 'A03', 'A04', 'A05', 'A06', 'A07', 'A08', 'A09', 'A10', 'A11', 'A12', 'A13', 'A14', 'A15', 'A16', 'A17', 'A18', 'A19', 'A20', 'A21', 'A22', 'A23', 'A24', 'A25', 'A26'] },
            'B': { name: 'ç»¿è‰²ç³»åˆ—', color: '#00C853', beads: ['B01', 'B02', 'B03', 'B04', 'B05', 'B06', 'B07', 'B08', 'B09', 'B10', 'B11', 'B12', 'B13', 'B14', 'B15', 'B16', 'B17', 'B18', 'B19', 'B20', 'B21', 'B23', 'B24', 'B25', 'B26', 'B27', 'B28', 'B29', 'B30', 'B31', 'B32'] },
            'C': { name: 'è“è‰²ç³»åˆ—', color: '#2979FF', beads: ['C01', 'C02', 'C03', 'C04', 'C05', 'C06', 'C07', 'C08', 'C09', 'C10', 'C11', 'C12', 'C13', 'C14', 'C15', 'C16', 'C18', 'C19', 'C20', 'C21', 'C23', 'C24', 'C25', 'C26', 'C27', 'C28', 'C29'] },
            'D': { name: 'ç´«è‰²ç³»åˆ—', color: '#AA00FF', beads: ['D01', 'D02', 'D03', 'D04', 'D05', 'D06', 'D07', 'D08', 'D09', 'D10', 'D11', 'D12', 'D13', 'D14', 'D15', 'D16', 'D18', 'D19', 'D20', 'D21', 'D23', 'D24', 'D25', 'D26'] },
            'E': { name: 'ç²‰è‰²ç³»åˆ—', color: '#FF4081', beads: ['E01', 'E02', 'E03', 'E04', 'E05', 'E06', 'E07', 'E08', 'E09', 'E10', 'E11', 'E12', 'E13', 'E14', 'E15', 'E16', 'E18', 'E19', 'E20', 'E21', 'E23', 'E24', 'E25'] },
            'F': { name: 'çº¢è‰²ç³»åˆ—', color: '#D50000', beads: ['F01', 'F02', 'F03', 'F04', 'F05', 'F06', 'F07', 'F08', 'F09', 'F10', 'F11', 'F12', 'F13', 'F14', 'F15', 'F16', 'F18', 'F19', 'F20', 'F21', 'F23', 'F24', 'F25'] },
            'G': { name: 'æ£•è‰²ç³»åˆ—', color: '#795548', beads: ['G01', 'G02', 'G03', 'G04', 'G05', 'G06', 'G07', 'G08', 'G09', 'G10', 'G11', 'G12', 'G13', 'G14', 'G15', 'G16', 'G17', 'G18', 'G19', 'G20', 'G21'] },
            'H': { name: 'é»‘è‰²ç³»', color: '#000000', beads: ['H01', 'H02', 'H03', 'H04', 'H05', 'H06', 'H07', 'H08', 'H09', 'H10', 'H11', 'H12', 'H13', 'H14', 'H15', 'H16', 'H17', 'H18', 'H19', 'H20', 'H21', 'H22', 'H23'] },
            'M': { name: 'ä½é¥±å’Œè‰²', color: '#9E9E9E', beads: ['M01', 'M02', 'M03', 'M04', 'M05', 'M06', 'M07', 'M08', 'M09', 'M10', 'M11', 'M12', 'M13', 'M14', 'M15', 'M16'] }
        };

        let inventory = JSON.parse(localStorage.getItem('beadInventory')) || {};
        let records = JSON.parse(localStorage.getItem('beadRecords')) || [];

        window.initInventory = function initInventory() {
            try {
                // è°ƒè¯•ï¼šè¾“å‡ºå½“å‰é…ç½®çš„ä½åº“å­˜é˜ˆå€¼
                const lowStockThreshold = config.inventoryConfig?.lowStockThreshold || 50;
                console.log('å½“å‰ä½åº“å­˜é˜ˆå€¼:', lowStockThreshold);
                console.log('config.inventoryConfig:', config.inventoryConfig);

                Object.keys(colorSeriesData).forEach(series => {
                    colorSeriesData[series].beads.forEach(bead => {
                        if (!inventory[bead]) {
                            inventory[bead] = 0;
                        }
                    });
                });
                saveInventory();
                renderColorSeries();
                updateStats();
                populateSelects();
                renderRecords();
                renderStats();
                console.log('åº“å­˜ç®¡ç†åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–åº“å­˜ç®¡ç†æ—¶å‡ºé”™:', error);
            }
        };

        function saveInventory() {
            localStorage.setItem('beadInventory', JSON.stringify(inventory));
        }

        function saveRecords() {
            localStorage.setItem('beadRecords', JSON.stringify(records));
        }

        function renderColorSeries() {
            const grid = document.getElementById('colorSeriesGrid');
            const searchInput = document.getElementById('searchInput');
            const filterSeriesSelect = document.getElementById('filterSeries');
            const filterStockSelect = document.getElementById('filterStock');
            const sortOrderSelect = document.getElementById('sortOrder');

            if (!grid) return;

            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const filterSeries = filterSeriesSelect ? filterSeriesSelect.value : 'all';
            const filterStock = filterStockSelect ? filterStockSelect.value : 'all';
            const sortOrder = sortOrderSelect ? sortOrderSelect.value : 'default';
            
            grid.innerHTML = '';
            
            let allBeads = [];
            
            Object.keys(colorSeriesData).forEach(series => {
                if (filterSeries !== 'all' && series !== filterSeries) return;
                
                const seriesData = colorSeriesData[series];
                seriesData.beads.forEach(bead => {
                    if (searchTerm && !bead.toLowerCase().includes(searchTerm)) return;
                    
                    const lowStockThreshold = config.inventoryConfig?.lowStockThreshold || 50;
                    if (filterStock === 'low' && inventory[bead] >= lowStockThreshold) return;
                    if (filterStock === 'normal' && inventory[bead] < lowStockThreshold) return;
                    
                    allBeads.push({
                        bead: bead,
                        series: series,
                        seriesData: seriesData,
                        stock: inventory[bead]
                    });
                });
            });
            
            if (sortOrder === 'asc') {
                allBeads.sort((a, b) => a.stock - b.stock);
            } else if (sortOrder === 'desc') {
                allBeads.sort((a, b) => b.stock - a.stock);
            }
            
            if (allBeads.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #636e72; padding: 40px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è‰²å·</div>';
                return;
            }
            
            let currentSeries = null;
            let currentCard = null;
            
            allBeads.forEach(item => {
                if (currentSeries !== item.series) {
                    currentSeries = item.series;
                    
                    if (currentCard) {
                        grid.appendChild(currentCard);
                    }
                    
                    currentCard = document.createElement('div');
                    currentCard.className = 'color-series-card';
                    currentCard.innerHTML = `
                        <div class="series-header">
                            <div class="series-color" style="background-color: ${item.seriesData.color};"></div>
                            <div class="series-name">${item.seriesData.name}</div>
                        </div>
                        <div class="bead-grid"></div>
                    `;
                }
                
                const beadGrid = currentCard.querySelector('.bead-grid');
                const lowStockThreshold = config.inventoryConfig?.lowStockThreshold || 50;
                const quickIncreaseAmount = config.inventoryConfig?.quickIncreaseAmount || 100;
                const quickDecreaseAmount = config.inventoryConfig?.quickDecreaseAmount || 15;
                beadGrid.innerHTML += `
                    <div class="bead-item">
                        <div class="bead-code">${item.bead}</div>
                        <div class="bead-stock ${item.stock < lowStockThreshold ? 'low' : ''}">${item.stock}å…‹</div>
                        <div class="bead-actions">
                            <button class="bead-btn bead-btn-in" onclick="quickStockChange('${item.bead}', 'in')">+${quickIncreaseAmount}å…‹</button>
                            <button class="bead-btn bead-btn-out" onclick="quickStockChange('${item.bead}', 'out')">-${quickDecreaseAmount}å…‹</button>
                        </div>
                    </div>
                `;
            });
            
            if (currentCard) {
                grid.appendChild(currentCard);
            }
        }

        function filterBeads() {
            renderColorSeries();
        }

        function updateStats() {
            let totalStock = 0;
            let lowStockCount = 0;
            const today = new Date().toDateString();
            const lowStockThreshold = config.inventoryConfig?.lowStockThreshold || 50;

            const totalStockEl = document.getElementById('totalStock');
            const todayInEl = document.getElementById('todayIn');
            const todayOutEl = document.getElementById('todayOut');
            const lowStockCountEl = document.getElementById('lowStockCount');

            if (!totalStockEl || !todayInEl || !todayOutEl || !lowStockCountEl) {
                return;
            }

            Object.keys(inventory).forEach(bead => {
                totalStock += inventory[bead];
                if (inventory[bead] < lowStockThreshold) lowStockCount++;
            });

            const todayRecords = records.filter(r => new Date(r.timestamp).toDateString() === today);
            const todayIn = todayRecords.filter(r => r.type === 'in').reduce((sum, r) => sum + r.amount, 0);
            const todayOut = todayRecords.filter(r => r.type === 'out').reduce((sum, r) => sum + r.amount, 0);

            totalStockEl.textContent = totalStock + 'å…‹';
            todayInEl.textContent = todayIn + 'å…‹';
            todayOutEl.textContent = todayOut + 'å…‹';
            lowStockCountEl.textContent = lowStockCount;
        }

        function populateSelects() {
            const inSelect = document.getElementById('inBeadSelect');
            const outSelect = document.getElementById('outBeadSelect');
            const batchSeriesSelect = document.getElementById('batchSeriesSelect');
            const filterSeriesSelect = document.getElementById('filterSeries');

            if (!inSelect || !outSelect || !batchSeriesSelect || !filterSeriesSelect) {
                return;
            }

            inSelect.innerHTML = '';
            outSelect.innerHTML = '';
            batchSeriesSelect.innerHTML = '<option value="all">å…¨éƒ¨è‰²ç³»</option>';
            filterSeriesSelect.innerHTML = '<option value="all">å…¨éƒ¨è‰²ç³»</option>';

            Object.keys(colorSeriesData).forEach(series => {
                const seriesData = colorSeriesData[series];
                const groupIn = document.createElement('optgroup');
                const groupOut = document.createElement('optgroup');
                groupIn.label = seriesData.name;
                groupOut.label = seriesData.name;
                
                seriesData.beads.forEach(bead => {
                    const optionIn = document.createElement('option');
                    optionIn.value = bead;
                    optionIn.textContent = `${bead} (${inventory[bead]}å…‹)`;
                    groupIn.appendChild(optionIn);
                    
                    const optionOut = document.createElement('option');
                    optionOut.value = bead;
                    optionOut.textContent = `${bead} (${inventory[bead]}å…‹)`;
                    groupOut.appendChild(optionOut);
                });
                
                inSelect.appendChild(groupIn);
                outSelect.appendChild(groupOut);
                
                const seriesOption = document.createElement('option');
                seriesOption.value = series;
                seriesOption.textContent = seriesData.name;
                batchSeriesSelect.appendChild(seriesOption);
                filterSeriesSelect.appendChild(seriesOption.cloneNode(true));
            });
        }

        window.openInModal = function openInModal() {
            try {
                populateSelects();
                const modal = document.getElementById('inModal');
                if (modal) {
                    modal.classList.add('active');
                    console.log('å…¥åº“æ¨¡æ€æ¡†å·²æ‰“å¼€');
                } else {
                    console.error('æ‰¾ä¸åˆ°å…¥åº“æ¨¡æ€æ¡†å…ƒç´ ');
                }
            } catch (error) {
                console.error('æ‰“å¼€å…¥åº“æ¨¡æ€æ¡†æ—¶å‡ºé”™:', error);
            }
        };

        window.openOutModal = function openOutModal() {
            try {
                populateSelects();
                const modal = document.getElementById('outModal');
                if (modal) {
                    modal.classList.add('active');
                    console.log('å‡ºåº“æ¨¡æ€æ¡†å·²æ‰“å¼€');
                } else {
                    console.error('æ‰¾ä¸åˆ°å‡ºåº“æ¨¡æ€æ¡†å…ƒç´ ');
                }
            } catch (error) {
                console.error('æ‰“å¼€å‡ºåº“æ¨¡æ€æ¡†æ—¶å‡ºé”™:', error);
            }
        };

        window.openBatchInModal = function openBatchInModal() {
            try {
                populateSelects();
                populateBatchBeads();
                const modal = document.getElementById('batchInModal');
                if (modal) {
                    modal.classList.add('active');
                    console.log('æ‰¹é‡å…¥åº“æ¨¡æ€æ¡†å·²æ‰“å¼€');
                } else {
                    console.error('æ‰¾ä¸åˆ°æ‰¹é‡å…¥åº“æ¨¡æ€æ¡†å…ƒç´ ');
                }
            } catch (error) {
                console.error('æ‰“å¼€æ‰¹é‡å…¥åº“æ¨¡æ€æ¡†æ—¶å‡ºé”™:', error);
            }
        };

        window.closeModal = function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        window.populateBatchBeads = function populateBatchBeads() {
            const series = document.getElementById('batchSeriesSelect').value;
            const list = document.getElementById('batchBeadList');

            list.innerHTML = '';

            const beadsToProcess = series === 'all'
                ? Object.keys(colorSeriesData).flatMap(s => colorSeriesData[s].beads)
                : colorSeriesData[series].beads;

            beadsToProcess.forEach(bead => {
                const item = document.createElement('div');
                item.className = 'batch-in-item';
                item.innerHTML = `
                    <label>${bead}</label>
                    <input type="number" class="batch-amount-input" data-bead="${bead}" min="0" placeholder="=">
                `;
                list.appendChild(item);
            });
        };

        window.setBatchDefaultAmount = function setBatchDefaultAmount() {
            const defaultAmount = document.getElementById('batchDefaultAmount').value;
            const inputs = document.querySelectorAll('.batch-amount-input');

            inputs.forEach(input => {
                if (defaultAmount) {
                    input.value = defaultAmount;
                }
            });
        };

        window.submitBatchIn = function submitBatchIn() {
            const remark = document.getElementById('batchRemark').value;
            const inputs = document.querySelectorAll('.batch-amount-input');
            let hasChanges = false;
            
            inputs.forEach(input => {
                const bead = input.dataset.bead;
                const amount = parseInt(input.value);
                
                if (amount && amount > 0) {
                    inventory[bead] += amount;
                    
                    const record = {
                        type: 'in',
                        bead: bead,
                        amount: amount,
                        remark: remark || 'æ‰¹é‡å…¥åº“',
                        timestamp: new Date().toISOString()
                    };
                    records.unshift(record);
                    hasChanges = true;
                }
            });
            
            if (!hasChanges) {
                alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªè‰²å·çš„å…¥åº“æ•°é‡');
                return;
            }
            
            saveInventory();
            saveRecords();
            
            closeModal('batchInModal');
            document.getElementById('batchDefaultAmount').value = '';
            document.getElementById('batchRemark').value = '';
            
            renderColorSeries();
            updateStats();
            renderRecords();
            renderStats();
            
            alert('æ‰¹é‡å…¥åº“æˆåŠŸï¼');
        }

        window.submitIn = function submitIn() {
            const bead = document.getElementById('inBeadSelect').value;
            const amount = parseInt(document.getElementById('inAmount').value);
            const remark = document.getElementById('inRemark').value;
            
            if (!bead || !amount || amount <= 0) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å…¥åº“ä¿¡æ¯');
                return;
            }
            
            inventory[bead] += amount;
            
            const record = {
                type: 'in',
                bead: bead,
                amount: amount,
                remark: remark,
                timestamp: new Date().toISOString()
            };
            records.unshift(record);
            
            saveInventory();
            saveRecords();
            
            closeModal('inModal');
            document.getElementById('inAmount').value = '';
            document.getElementById('inRemark').value = '';
            
            renderColorSeries();
            updateStats();
            renderRecords();
            renderStats();
            
            alert('å…¥åº“æˆåŠŸï¼');
        };

        window.submitOut = function submitOut() {
            const bead = document.getElementById('outBeadSelect').value;
            const amount = parseInt(document.getElementById('outAmount').value);
            const remark = document.getElementById('outRemark').value;
            
            if (!bead || !amount || amount <= 0) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å‡ºåº“ä¿¡æ¯');
                return;
            }
            
            if (inventory[bead] < amount) {
                alert('åº“å­˜ä¸è¶³ï¼');
                return;
            }
            
            inventory[bead] -= amount;
            
            const record = {
                type: 'out',
                bead: bead,
                amount: amount,
                remark: remark,
                timestamp: new Date().toISOString()
            };
            records.unshift(record);
            
            saveInventory();
            saveRecords();
            
            closeModal('outModal');
            document.getElementById('outAmount').value = '';
            document.getElementById('outRemark').value = '';
            
            renderColorSeries();
            updateStats();
            renderRecords();
            renderStats();
            
            alert('å‡ºåº“æˆåŠŸï¼');
        };

        window.quickStockChange = function quickStockChange(bead, type) {
            const quickIncreaseAmount = config.inventoryConfig?.quickIncreaseAmount || 100;
            const quickDecreaseAmount = config.inventoryConfig?.quickDecreaseAmount || 15;
            const amount = type === 'in' ? quickIncreaseAmount : quickDecreaseAmount;
            
            if (type === 'out' && inventory[bead] < amount) {
                alert('åº“å­˜ä¸è¶³ï¼');
                return;
            }
            
            if (type === 'in') {
                inventory[bead] += amount;
            } else {
                inventory[bead] -= amount;
            }
            
            const record = {
                type: type,
                bead: bead,
                amount: amount,
                remark: 'å¿«æ·æ“ä½œ',
                timestamp: new Date().toISOString()
            };
            records.unshift(record);
            
            saveInventory();
            saveRecords();
            
            renderColorSeries();
            updateStats();
            renderRecords();
            renderStats();
        };

        window.switchTab = function switchTab(tab) {
            try {
                document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

                const tabElement = document.getElementById(tab + 'Tab');
                if (tabElement) {
                    tabElement.style.display = 'block';
                    if (event && event.target) {
                        event.target.classList.add('active');
                    }
                    console.log('åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tab);
                } else {
                    console.error('æ‰¾ä¸åˆ°æ ‡ç­¾é¡µå…ƒç´ :', tab);
                }
            } catch (error) {
                console.error('åˆ‡æ¢æ ‡ç­¾é¡µæ—¶å‡ºé”™:', error);
            }
        };

        window.renderRecords = function renderRecords() {
            const list = document.getElementById('recordList');
            const recordSearchInput = document.getElementById('recordSearchInput');

            if (!list) return;

            const searchTerm = recordSearchInput ? recordSearchInput.value.toLowerCase() : '';

            const filteredRecords = records.filter(r =>
                r.bead.toLowerCase().includes(searchTerm) ||
                (r.remark && r.remark.toLowerCase().includes(searchTerm))
            );

            list.innerHTML = filteredRecords.map(record => `
                <div class="record-item">
                    <div class="record-info">
                        <div class="record-bead">${record.bead}</div>
                        <div class="record-detail">
                            ${record.type === 'in' ? 'å…¥åº“' : 'å‡ºåº“'} | 
                            ${new Date(record.timestamp).toLocaleString('zh-CN')} |
                            ${record.remark || 'æ— å¤‡æ³¨'}
                        </div>
                    </div>
                    <div class="record-amount ${record.type}">
                        ${record.type === 'in' ? '+' : '-'}${record.amount}å…‹
                    </div>
                </div>
            `).join('');
        };

        window.filterRecords = function filterRecords() {
            renderRecords();
        };

        window.exportToExcel = function exportToExcel() {
            try {
                const rows = [
                    ['è‰²å·', 'è‰²ç³»', 'åº“å­˜ï¼ˆå…‹ï¼‰', 'å æ¯”ï¼ˆ%ï¼‰', 'çŠ¶æ€']
                ];

                const totalStock = Object.keys(inventory).reduce((sum, bead) => sum + inventory[bead], 0);

                Object.keys(colorSeriesData).forEach(series => {
                    colorSeriesData[series].beads.forEach(bead => {
                        const stock = inventory[bead];
                        const percentage = totalStock > 0 ? ((stock / totalStock) * 100).toFixed(1) : 0;
                        const lowStockThreshold = config.inventoryConfig?.lowStockThreshold || 50;
                        const status = stock < lowStockThreshold ? 'ä½åº“å­˜' : 'æ­£å¸¸';
                        rows.push([bead, colorSeriesData[series].name, stock, percentage, status]);
                    });
                });

                rows.push([]);
                rows.push(['è‰²ç³»', 'æ€»åº“å­˜ï¼ˆå…‹ï¼‰', 'å æ¯”ï¼ˆ%ï¼‰']);

                let seriesTotals = {};
                Object.keys(colorSeriesData).forEach(series => {
                    seriesTotals[series] = 0;
                    colorSeriesData[series].beads.forEach(bead => {
                        seriesTotals[series] += inventory[bead];
                    });
                });

                Object.keys(seriesTotals).forEach(series => {
                    const total = seriesTotals[series];
                    const percentage = totalStock > 0 ? ((total / totalStock) * 100).toFixed(1) : 0;
                    rows.push([colorSeriesData[series].name, total, percentage]);
                });

                rows.push([]);
                rows.push(['æ—¥æœŸ', 'ç±»å‹', 'è‰²å·', 'æ•°é‡ï¼ˆå…‹ï¼‰', 'å¤‡æ³¨']);

                records.forEach(record => {
                    const date = new Date(record.timestamp).toLocaleDateString('zh-CN');
                    const type = record.type === 'in' ? 'å…¥åº“' : 'å‡ºåº“';
                    rows.push([date, type, record.bead, record.amount, record.remark || '']);
                });

                const csvContent = rows.map(row => row.join(',')).join('\n');
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `åº“å­˜æŠ¥è¡¨_${new Date().toLocaleDateString('zh-CN')}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);
                console.log('Excelå¯¼å‡ºæˆåŠŸ');
            } catch (error) {
                console.error('å¯¼å‡ºExcelæ—¶å‡ºé”™:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        };

        window.renderStats = function renderStats() {
            const consumptionOverview = document.getElementById('consumptionOverview');
            const seriesConsumption = document.getElementById('seriesConsumption');
            const beadConsumption = document.getElementById('beadConsumption');
            const stockRanking = document.getElementById('stockRanking');
            const lowStockWarning = document.getElementById('lowStockWarning');
            const dailyTrend = document.getElementById('dailyTrend');
            const statsDaysTitle = document.getElementById('statsDaysTitle');

            // å¦‚æœè¿™äº›å…ƒç´ ä¸å­˜åœ¨ï¼Œè¯´æ˜åœ¨ç»Ÿè®¡åˆ†ææ ‡ç­¾é¡µä¹‹å¤–ï¼Œç›´æ¥è¿”å›
            if (!consumptionOverview || !seriesConsumption || !beadConsumption ||
                !stockRanking || !lowStockWarning || !dailyTrend) {
                return;
            }

            // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºçš„å¤©æ•°
            const statsDays = config.inventoryConfig?.statsDays || 7;
            if (statsDaysTitle) {
                statsDaysTitle.textContent = `ğŸ“Š æ¶ˆè€—æ¦‚è§ˆï¼ˆæœ€è¿‘${statsDays}å¤©ï¼‰`;
            }

            const lastDays = [];
            for (let i = statsDays - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                lastDays.push(date);
            }
            
            const dayStats = lastDays.map(date => {
                const dayRecords = records.filter(r => 
                    new Date(r.timestamp).toDateString() === date.toDateString()
                );
                const inAmount = dayRecords.filter(r => r.type === 'in').reduce((sum, r) => sum + r.amount, 0);
                const outAmount = dayRecords.filter(r => r.type === 'out').reduce((sum, r) => sum + r.amount, 0);
                return { date, inAmount, outAmount, netAmount: inAmount - outAmount };
            });
            
            const totalOutDays = dayStats.reduce((sum, d) => sum + d.outAmount, 0);
            const totalInDays = dayStats.reduce((sum, d) => sum + d.inAmount, 0);
            const netAmountAmount = totalInDays - totalOutDays;
            const avgDailyOut = Math.round(totalOutDays / statsDays);
            
            consumptionOverview.innerHTML = `
                <div class="overview-cards">
                    <div class="overview-card out">
                        <div class="label">${statsDays}å¤©æ€»æ¶ˆè€—</div>
                        <div class="value">${totalOutDays}å…‹</div>
                    </div>
                    <div class="overview-card">
                        <div class="label">æ—¥å‡æ¶ˆè€—</div>
                        <div class="value">${avgDailyOut}å…‹</div>
                    </div>
                    <div class="overview-card net">
                        <div class="label">å‡€å˜åŒ–</div>
                        <div class="value">${netAmountAmount >= 0 ? '+' : ''}${netAmountAmount}å…‹</div>
                    </div>
                </div>
            `;
            
            let beadConsumptionMap = {};
            records.filter(r => r.type === 'out').forEach(r => {
                if (!beadConsumptionMap.hasOwnProperty(r.bead)) {
                    beadConsumptionMap[r.bead] = 0;
                }
                beadConsumptionMap[r.bead] += r.amount;
            });
            
            let seriesConsumptionMap = {};
            Object.keys(colorSeriesData).forEach(series => {
                seriesConsumptionMap[series] = 0;
                colorSeriesData[series].beads.forEach(bead => {
                    seriesConsumptionMap[series] += beadConsumptionMap[bead] || 0;
                });
            });
            
            const sortedSeries = Object.keys(seriesConsumptionMap).sort((a, b) => seriesConsumptionMap[b] - seriesConsumptionMap[a]);
            
            if (totalOutDays > 0) {
                seriesConsumption.innerHTML = sortedSeries.map((series, index) => {
                    const total = seriesConsumptionMap[series];
                    const percentage = (total / totalOutDays * 100).toFixed(1);
                    return `
                        <div class="rank-item">
                            <div class="rank-number ${index < 3 ? 'top3' : ''}">${index + 1}</div>
                            <div class="rank-info">
                                <div class="rank-name">${colorSeriesData[series].name}</div>
                                <div class="rank-value">å æ¯” ${percentage}%</div>
                            </div>
                            <div class="rank-amount">${total}å…‹</div>
                        </div>
                    `;
                }).join('');
            } else {
                seriesConsumption.innerHTML = '<div style="text-align: center; color: #636e72; padding: 20px;">æš‚æ— æ¶ˆè€—è®°å½•</div>';
            }
            
            const sortedBeads = Object.keys(beadConsumptionMap).sort((a, b) => beadConsumptionMap[b] - beadConsumptionMap[a]).slice(0, 10);
            
            if (totalOutDays > 0) {
                beadConsumption.innerHTML = sortedBeads.map((bead, index) => {
                    const total = beadConsumptionMap[bead];
                    const percentage = (total / totalOutDays * 100).toFixed(1);
                    return `
                        <div class="rank-item">
                            <div class="rank-number ${index < 3 ? 'top3' : ''}">${index + 1}</div>
                            <div class="rank-info">
                                <div class="rank-name">${bead}</div>
                                <div class="rank-value">å æ¯” ${percentage}%</div>
                            </div>
                            <div class="rank-amount">${total}å…‹</div>
                        </div>
                    `;
                }).join('');
            } else {
                beadConsumption.innerHTML = '<div style="text-align: center; color: #636e72; padding: 20px;">æš‚æ— æ¶ˆè€—è®°å½•</div>';
            }
            
            const stockArray = Object.keys(inventory).map(bead => ({
                bead: bead,
                stock: inventory[bead]
            })).sort((a, b) => b.stock - a.stock);
            
            const totalStock = stockArray.reduce((sum, item) => sum + item.stock, 0);
            
            if (totalStock > 0) {
                stockRanking.innerHTML = stockArray.map((item, index) => {
                    const percentage = (item.stock / totalStock * 100).toFixed(1);
                    return `
                        <div class="rank-item">
                            <div class="rank-number ${index < 3 ? 'top3' : ''}">${index + 1}</div>
                            <div class="rank-info">
                                <div class="rank-name">${item.bead}</div>
                                <div class="rank-value">å æ¯” ${percentage}%</div>
                            </div>
                            <div class="rank-amount" style="color: #11998e;">${item.stock}å…‹</div>
                        </div>
                    `;
                }).join('');
            } else {
                stockRanking.innerHTML = '<div style="text-align: center; color: #636e72; padding: 20px;">æš‚æ— åº“å­˜</div>';
            }
            
            const lowStockThreshold = config.inventoryConfig?.lowStockThreshold || 50;
            const lowStockArray = Object.keys(inventory).filter(bead => inventory[bead] < lowStockThreshold).map(bead => ({
                bead: bead,
                stock: inventory[bead]
            })).sort((a, b) => a.stock - b.stock);
            
            if (lowStockArray.length === 0) {
                lowStockWarning.innerHTML = '<div style="text-align: center; color: #636e72; padding: 20px;">âœ… æš‚æ— ä½åº“å­˜è‰²å·</div>';
            } else {
                lowStockWarning.innerHTML = lowStockArray.map((item, index) => {
                    return `
                        <div class="rank-item">
                            <div class="rank-number" style="background: #f45c43;">${index + 1}</div>
                            <div class="rank-info">
                                <div class="rank-name">${item.bead}</div>
                                <div class="rank-value">åº“å­˜ä¸è¶³${lowStockThreshold}å…‹</div>
                            </div>
                            <div class="rank-amount" style="color: #f45c43;">${item.stock}å…‹</div>
                        </div>
                    `;
                }).join('');
            }
            
            const maxDailyOut = Math.max(...dayStats.map(d => d.outAmount), 1);
            
            dailyTrend.innerHTML = `
                <div class="trend-line">
                    ${dayStats.map(stat => {
                        const height = (stat.outAmount / maxDailyOut * 100);
                        return `
                            <div class="trend-item">
                                <div class="trend-bar" style="height: ${height}%"></div>
                                <div class="trend-value">${stat.outAmount}å…‹</div>
                                <div class="trend-label">${stat.date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' })}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };

        // è¾…åŠ©å‡½æ•°ä¹Ÿæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.filterBeads = function filterBeads() {
            renderColorSeries();
        };

        window.updateStats = function updateStats() {
            let totalStock = 0;
            let lowStockCount = 0;
            const today = new Date().toDateString();
            const lowStockThreshold = config.inventoryConfig?.lowStockThreshold || 50;

            const totalStockEl = document.getElementById('totalStock');
            const todayInEl = document.getElementById('todayIn');
            const todayOutEl = document.getElementById('todayOut');
            const lowStockCountEl = document.getElementById('lowStockCount');

            if (!totalStockEl || !todayInEl || !todayOutEl || !lowStockCountEl) {
                return;
            }

            Object.keys(inventory).forEach(bead => {
                totalStock += inventory[bead];
                if (inventory[bead] < lowStockThreshold) lowStockCount++;
            });

            const todayRecords = records.filter(r => new Date(r.timestamp).toDateString() === today);
            const todayIn = todayRecords.filter(r => r.type === 'in').reduce((sum, r) => sum + r.amount, 0);
            const todayOut = todayRecords.filter(r => r.type === 'out').reduce((sum, r) => sum + r.amount, 0);

            totalStockEl.textContent = totalStock + 'å…‹';
            todayInEl.textContent = todayIn + 'å…‹';
            todayOutEl.textContent = todayOut + 'å…‹';
            lowStockCountEl.textContent = lowStockCount;
        };

        window.populateSelects = function populateSelects() {
            const inSelect = document.getElementById('inBeadSelect');
            const outSelect = document.getElementById('outBeadSelect');
            const batchSeriesSelect = document.getElementById('batchSeriesSelect');
            const filterSeriesSelect = document.getElementById('filterSeries');

            if (!inSelect || !outSelect || !batchSeriesSelect || !filterSeriesSelect) {
                return;
            }

            inSelect.innerHTML = '';
            outSelect.innerHTML = '';
            batchSeriesSelect.innerHTML = '<option value="all">å…¨éƒ¨è‰²ç³»</option>';
            filterSeriesSelect.innerHTML = '<option value="all">å…¨éƒ¨è‰²ç³»</option>';

            Object.keys(colorSeriesData).forEach(series => {
                const seriesData = colorSeriesData[series];
                const groupIn = document.createElement('optgroup');
                const groupOut = document.createElement('optgroup');
                groupIn.label = seriesData.name;
                groupOut.label = seriesData.name;

                seriesData.beads.forEach(bead => {
                    const optionIn = document.createElement('option');
                    optionIn.value = bead;
                    optionIn.textContent = `${bead} (${inventory[bead]}å…‹)`;
                    groupIn.appendChild(optionIn);

                    const optionOut = document.createElement('option');
                    optionOut.value = bead;
                    optionOut.textContent = `${bead} (${inventory[bead]}å…‹)`;
                    groupOut.appendChild(optionOut);
                });

                inSelect.appendChild(groupIn);
                outSelect.appendChild(groupOut);

                const seriesOption = document.createElement('option');
                seriesOption.value = series;
                seriesOption.textContent = seriesData.name;
                batchSeriesSelect.appendChild(seriesOption);
                filterSeriesSelect.appendChild(seriesOption.cloneNode(true));
            });
        };

        // ç›´æ¥åˆå§‹åŒ–ï¼Œå› ä¸ºæ‰€æœ‰å‡½æ•°éƒ½åœ¨åŒä¸€ä¸ªscriptæ ‡ç­¾å†…å®šä¹‰
        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', initInventory);
        } else {
            // å¦‚æœæ–‡æ¡£å·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–
            initInventory();
        }
    </script>
</body>
</html>